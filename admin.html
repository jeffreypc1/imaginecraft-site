<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - ImagineCraft Studios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1F1F1F;
            --background: #FAFAF7;
            --accent: #5B5FEA;
            --glass: rgba(255, 255, 255, 0.1);
            --charcoal: var(--primary);
            --off-white: var(--background);
            --charcoal-light: #2a2a2a;
            --off-white-dark: #e8e8e5;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--charcoal);
            color: var(--off-white);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--off-white);
            font-size: 0.95rem;
            font-weight: 400;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .nav-links a:hover {
            opacity: 1;
        }

        /* Dashboard Section */
        .dashboard {
            display: block;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
        }

        .dashboard-actions .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #16a34a;
        }

        .btn-danger {
            background-color: var(--error);
            border-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Hero Text Section */
        .hero-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .hero-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .hero-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .hero-section input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .hero-section input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Navigation Links Section */
        .nav-links-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .nav-links-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .nav-links-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .nav-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .nav-links-section .form-group {
            margin-bottom: 0;
        }

        .nav-links-section label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-links-section input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .nav-links-section input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Thought Cards */
        .thoughts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .thought-card {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .thought-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .thought-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .thought-card .card-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .thought-card .card-number {
            background: var(--charcoal);
            color: var(--off-white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .thought-card label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .thought-card input,
        .thought-card textarea {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .thought-card input:focus,
        .thought-card textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .thought-card textarea {
            min-height: 80px;
            resize: vertical;
        }

        .thought-card textarea.thought-textarea {
            min-height: 250px;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
        }

        .thought-card .form-group {
            margin-bottom: 1rem;
        }

        .thought-card .form-group:last-child {
            margin-bottom: 0;
        }

        /* Action Type Dropdown */
        .thought-card select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F1F1F' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .thought-card select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Conditional Action Fields */
        .action-fields {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--background);
            border-radius: 8px;
            border: 1px dashed var(--off-white-dark);
        }

        .action-fields.hidden {
            display: none;
        }

        .action-fields label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .action-fields input,
        .action-fields textarea {
            margin-top: 0.5rem;
        }

        .action-fields textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            min-height: 120px;
            line-height: 1.4;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--charcoal);
            color: var(--off-white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        /* Typing Speed Section */
        .typing-speed-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .typing-speed-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .typing-speed-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .slider-container {
            max-width: 400px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--off-white-dark);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .speed-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(91, 95, 234, 0.2);
        }

        .speed-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: var(--primary);
        }

        .slider-value span {
            font-weight: 600;
            color: var(--accent);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--off-white-dark);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.2);
        }

        .toggle-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--primary);
        }

        /* Active Checkbox for Thought Cards */
        .active-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .active-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .active-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
        }

        .thought-card.inactive {
            opacity: 0.6;
            border-color: var(--off-white-dark);
        }

        .thought-card.inactive .card-number {
            background: var(--off-white-dark);
            color: rgba(31, 31, 31, 0.5);
        }

        /* Questions Header Section with Randomize Toggle */
        .questions-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 12px;
        }

        .randomize-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .randomize-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .randomize-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
        }

        .randomize-hint {
            font-size: 0.8rem;
            color: rgba(31, 31, 31, 0.5);
            font-style: italic;
        }

        /* Mood Selector Styles */
        .mood-selector-container {
            max-width: 500px;
        }

        .mood-select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F1F1F' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .mood-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .mood-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #000000;
            border-radius: 8px;
            font-family: 'VT323', 'Courier New', monospace;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

        .mood-preview-text {
            display: inline-block;
        }

        .mood-preview.stable {
            color: #34ff35;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.6);
        }

        .mood-preview.glitchy {
            color: #34ff35;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.6);
            animation: glitchPreview 0.5s infinite;
        }

        .mood-preview.urgent {
            color: #ff3434;
            text-shadow: 0 0 8px rgba(255, 52, 52, 0.6);
        }

        @keyframes glitchPreview {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); }
            40% { transform: translate(1px, -1px); filter: hue-rotate(180deg); }
            60% { transform: translate(-1px, 0); filter: hue-rotate(270deg); }
            80% { transform: translate(2px, 1px); filter: hue-rotate(360deg); }
            100% { transform: translate(0); filter: hue-rotate(0deg); }
        }

        /* Secret Commands Section */
        .secret-commands-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .secret-commands-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .secret-commands-section > p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1.5rem;
        }

        .secret-commands-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .secret-command-card {
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 12px;
            padding: 1.25rem;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .secret-command-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            border-color: var(--accent);
        }

        .secret-command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .secret-command-keyword {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .keyword-badge {
            background: linear-gradient(135deg, #1F1F1F, #2a2a2a);
            color: #34ff35;
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            letter-spacing: 0.1em;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.4);
            box-shadow: inset 0 0 10px rgba(52, 255, 53, 0.1);
        }

        .secret-command-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .secret-command-body {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .secret-command-body .form-group {
            margin-bottom: 0;
        }

        .secret-command-body label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .secret-command-body input,
        .secret-command-body select {
            width: 100%;
            padding: 0.6rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.9rem;
            color: var(--primary);
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 6px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .secret-command-body input:focus,
        .secret-command-body select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .secret-command-body .url-field {
            grid-column: span 2;
        }

        @media (max-width: 600px) {
            .secret-command-body .url-field {
                grid-column: span 1;
            }
        }

        .delete-command-btn {
            background: transparent;
            border: 1px solid var(--error);
            color: var(--error);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-command-btn:hover {
            background: var(--error);
            color: white;
        }

        .add-command-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 2px dashed var(--accent);
            color: var(--accent);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-command-btn:hover {
            background: rgba(91, 95, 234, 0.1);
            border-style: solid;
        }

        .add-command-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Builders Media Section Input Styles */
        .typing-speed-section .nav-links-grid input,
        .typing-speed-section .nav-links-grid select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .typing-speed-section .nav-links-grid input:focus,
        .typing-speed-section .nav-links-grid select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .typing-speed-section .nav-links-grid label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .login-card {
                padding: 2rem;
            }

            .dashboard {
                padding: 1.5rem;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .thoughts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">ImagineCraft Studios</div>
        <nav>
            <ul class="nav-links">
                <li><a href="main.html">Main Site</a></li>
                <li><a href="index.html">Explore</a></li>
            </ul>
        </nav>
    </header>

    <!-- Dashboard Section -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <h1>Remote Config Generator</h1>
            <div class="dashboard-actions">
                <button class="btn btn-success" onclick="downloadConfig()">Push Live Update</button>
                <button class="btn btn-danger" onclick="factoryReset()" disabled style="opacity: 0.5; cursor: not-allowed;">Reset to Defaults (Disabled)</button>
            </div>
        </div>

        <!-- Instructions Banner -->
        <div style="background: linear-gradient(135deg, #5B5FEA, #4a4ed8); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(91, 95, 234, 0.2);">
            <h3 style="margin: 0 0 0.75rem 0; font-size: 1.1rem; font-weight: 600;">How to Update Your Site</h3>
            <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.95rem; line-height: 1.8;">
                <li>Edit your content below (changes are temporary - not saved automatically)</li>
                <li>Click "Push Live Update" to instantly publish to all browsers via Firebase</li>
                <li>All connected browsers will update in real-time - no refresh needed!</li>
            </ol>
            <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">Note: This panel doesn't save changes permanently until you push them live. All your edits exist only in this session until you click "Push Live Update".</p>
        </div>
        <!-- Hero Text Section -->
        <div class="hero-section">
            <h2>Hero Heading</h2>
            <p>This is the main static heading displayed at the top. It does not cycle like the thoughts.</p>
            <input type="text" id="heroText" placeholder="Enter hero heading..." value="WHY ARE YOU HERE?">
        </div>

        <!-- Site Configuration Section -->
        <div class="hero-section">
            <h2>Site Configuration</h2>
            <p>Configure global site settings and visual elements.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>MST3K Overlay URL</label>
                    <input type="url" id="mst3kOverlayURL" placeholder="https://example.com/mst3k-silhouettes.png">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Transparent PNG overlay for the MST3K theater silhouettes (positioned at bottom of screen)
                    </p>
                </div>
                <div class="form-group">
                    <label>MST3K Screen Glow Intensity</label>
                    <input type="number" id="mst3kGlowIntensity" placeholder="0.6" min="0" max="1" step="0.1">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Controls the green glow transparency (0 = no glow, 1 = maximum glow)
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Theater Frame URL</label>
                    <input type="url" id="theaterFrameURL" placeholder="https://example.com/curtainbkg.png">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Permanent theater curtain frame overlay (positioned as full-screen background behind silhouettes)
                    </p>
                </div>
            </div>
        </div>

        <!-- Global Ambient Audio Section -->
        <div class="typing-speed-section">
            <h2>Global Ambient Audio</h2>
            <p>Set a background audio track that loops continuously after the user's first interaction. Scene-specific overrides can replace this audio temporarily.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Global Ambient Audio URL</label>
                    <input type="url" id="globalAmbientAudioURL" placeholder="https://example.com/ambient-loop.mp3">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Audio will start on loop after the user clicks anywhere on the site for the first time.
                    </p>
                </div>
            </div>
        </div>

        <!-- Enable Choice Buttons Section -->
        <div class="typing-speed-section">
            <h2>Enable Choice Buttons</h2>
            <p>When enabled, Yes/No buttons appear after each thought finishes typing. "Yes" shows the response, "No" skips to the next thought. When disabled, thoughts auto-cycle after a linger period.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="choiceButtonsToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="choiceButtonsToggleLabel">Disabled</span>
            </div>
        </div>

        <!-- Matrix Fade Duration Section -->
        <div class="typing-speed-section">
            <h2>Matrix Fade Duration</h2>
            <p>Adjust how long the Matrix rain animation takes to fade out. This controls the cinematic disappearance effect.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (0.5s)</span>
                    <span>Slow (5s)</span>
                </div>
                <input type="range" id="matrixFadeSlider" min="0.5" max="5" step="0.1" value="1.5" class="speed-slider">
                <div class="slider-value">
                    <span id="matrixFadeValue">1.5</span>s fade duration
                </div>
            </div>
        </div>

        <!-- Earthquake Duration Section -->
        <div class="typing-speed-section">
            <h2>Earthquake Duration</h2>
            <p>Adjust how many seconds the screen shakes before the terminal splits and reveals the main site. Longer durations create more dramatic tension.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (0.5s)</span>
                    <span>Long (5s)</span>
                </div>
                <input type="range" id="earthquakeDurationSlider" min="0.5" max="5" step="0.1" value="1.5" class="speed-slider">
                <div class="slider-value">
                    <span id="earthquakeDurationValue">1.5</span>s shake duration
                </div>
            </div>
        </div>

        <!-- Curtain Rise Duration Section -->
        <div class="typing-speed-section">
            <h2>Curtain Rise Duration</h2>
            <p>Adjust how long the theater curtain takes to split and reveal the terminal. The typing animation will begin only after the curtain has fully risen. Longer durations create more anticipation.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (1s)</span>
                    <span>Dramatic (10s)</span>
                </div>
                <input type="range" id="curtainDurationSlider" min="1" max="10" step="0.5" value="4" class="speed-slider">
                <div class="slider-value">
                    <span id="curtainDurationValue">4</span>s curtain rise
                </div>
            </div>
        </div>

        <!-- Earthquake Transition Section -->
        <div class="typing-speed-section">
            <h2>Earthquake Transition</h2>
            <p>When enabled, clicking "Enter Main Site" will trigger a dramatic earthquake shake and screen crack effect before navigating to the main site.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="earthquakeToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="earthquakeToggleLabel">Enabled</span>
            </div>
        </div>

        <!-- Boot Sequence Section -->
        <div class="typing-speed-section">
            <h2>Enable Boot Sequence</h2>
            <p>When enabled, the site will display a "Power Up" boot sequence with system diagnostics and a progress bar on first load. The sequence only plays once per browser session.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="bootSequenceToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="bootSequenceToggleLabel">Enabled</span>
            </div>
        </div>

        <!-- Boot Sequence Script Section -->
        <div class="typing-speed-section">
            <h2>Boot Sequence Script</h2>
            <p>Customize the diagnostic lines shown during the boot sequence. Enter one line per row. Each line will be typed out with the green terminal style and fast typing speed.</p>
            <textarea id="bootScriptTextarea"
                      style="width: 100%; min-height: 150px; padding: 0.75rem; font-family: 'VT323', 'Courier New', monospace; font-size: 1rem; color: var(--primary); background: var(--background); border: 1px solid var(--off-white-dark); border-radius: 8px; resize: vertical; line-height: 1.5;"
                      placeholder="CORE_INIT: OK&#10;MEM_LOAD: 1024KB&#10;DRV_MOUNT: /assets&#10;NET_STACK: READY&#10;SYS_CHECK: COMPLETE">CORE_INIT: OK
MEM_LOAD: 1024KB
DRV_MOUNT: /assets
NET_STACK: READY
SYS_CHECK: COMPLETE</textarea>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Keep lines short and tech-y for the best effect. Use colons and status words like OK, READY, COMPLETE, etc.
            </p>
        </div>

        <!-- Background Image Section -->
        <div class="typing-speed-section">
            <h2>Background Image URL</h2>
            <p>Set the background image shown behind the curtains during the opening sequence. This image will be revealed when the boot sequence completes and the black overlay fades out.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Background Image URL</label>
                    <input type="url" id="backgroundImageUrl" placeholder="https://example.com/background.jpg">
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: For best results, use a high-resolution image. The image will be positioned behind the terminal text/buttons but in front of the black background. If the image takes more than 3 seconds to load, the site will continue anyway.
            </p>
        </div>

        <!-- Builders Media Section (for TRANSPARENT command) -->
        <div class="typing-speed-section">
            <h2>Builders Image/Video URL</h2>
            <p>Set the image or video URL shown behind the terminal when the TRANSPARENT command is triggered. This creates the illusion of builders constructing the site behind the screen.</p>
            <div class="nav-links-grid">
                <div class="form-group">
                    <label>Media Type</label>
                    <select id="buildersMediaType" class="mood-select" style="max-width: 200px;">
                        <option value="image">Image</option>
                        <option value="video">Video (MP4)</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Media URL</label>
                    <input type="url" id="buildersMediaUrl" placeholder="https://example.com/construction-crew.jpg (or .mp4)">
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: For best results, use an image or video of a construction crew with hammers and tools. If left blank, a placeholder animation will be shown.
            </p>
        </div>

        <!-- Cinematic States Section -->
        <div class="typing-speed-section">
            <h2>Cinematic State Overlays</h2>
            <p>Configure the images displayed during automated cinematic states. These overlays are triggered automatically based on user interaction patterns.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Intermission Image URL</label>
                    <input type="url" id="intermissionImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Intermission">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered after 120 seconds of user inactivity
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Technical Difficulties Image URL</label>
                    <input type="url" id="techDifficultyImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Technical+Difficulties">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered after 3 consecutive terminal input errors
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Fin (The End) Image URL</label>
                    <input type="url" id="finImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Fin">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered by the "Trigger Fin" action type in cycling thoughts
                    </p>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Use placeholder URLs until your final cinematic images are ready. Once you update these URLs, the site will automatically pull the new images.
            </p>
        </div>

        <!-- Meltdown Configuration Section -->
        <div class="typing-speed-section">
            <h2>Meltdown Configuration</h2>
            <p>Configure hidden meltdown triggers using [] brackets in Cycling Thoughts. When a user types a bracketed keyword, it triggers a critical system meltdown sequence.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Meltdown Message</label>
                    <input type="text" id="meltdownMessage" placeholder="CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        The high-alert red text that rapidly types during a meltdown sequence
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Meltdown Audio URL</label>
                    <input type="url" id="meltdownAudioURL" placeholder="https://example.com/alarm.mp3">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Audio/music to play during the meltdown sequence (10 seconds)
                    </p>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Use [] brackets in Cycling Thoughts to define hidden meltdown triggers. Example: "What is [DESTROY]?" will trigger meltdown when user types "DESTROY".
            </p>
        </div>

        <!-- Managed Secret Commands Section -->
        <div class="secret-commands-section">
            <h2>Managed Secret Commands</h2>
            <p>Configure hidden keywords that trigger special actions when typed anywhere on the terminal. Users can type these keywords to activate hidden features.</p>

            <div class="secret-commands-list" id="secretCommandsList">
                <!-- Command cards will be generated by JavaScript -->
            </div>

            <button type="button" class="add-command-btn" onclick="addNewSecretCommand()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Command
            </button>
        </div>

        <!-- Questions Section with Randomize Toggle -->
        <div class="questions-header-section">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0; color: var(--primary);">Cycling Thoughts & Responses</h2>
            <div class="randomize-toggle-container">
                <input type="checkbox" id="randomizeToggle" class="randomize-checkbox">
                <label for="randomizeToggle" class="randomize-label">Randomize Active Questions</label>
                <span class="randomize-hint">(When enabled, shows 3 random active questions instead of all)</span>
            </div>
        </div>
        <div class="thoughts-grid" id="thoughtsGrid">
            <!-- Cards will be generated by JavaScript -->
        </div>

        <button type="button" class="add-command-btn" onclick="addNewThought()" style="margin-top: 1.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add New Thought
        </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Changes saved successfully!</span>
    </div>

    <script type="module">
        // ========================================
        // Firebase Configuration
        // ========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Initialize Firebase with your project credentials
        const firebaseConfig = {
            apiKey: "AIzaSyC9Ga6OROaym45ezFh_vJ2WFMVUACkMGXY",
            authDomain: "imaginecraft-live.firebaseapp.com",
            databaseURL: "https://imaginecraft-live-default-rtdb.firebaseio.com",
            projectId: "imaginecraft-live",
            storageBucket: "imaginecraft-live.firebasestorage.app",
            messagingSenderId: "962150460666",
            appId: "1:962150460666:web:382bff8cdb23c191c16d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Remote configuration (loaded from config.json)
        let remoteConfig = null;

        // Hard-coded defaults removed - Firebase is the sole source of truth
        const fallbackThoughts = [];

        const fallbackResponses = [];

        const fallbackHeroText = '';

        // Helper functions to get data from Firebase only (no fallbacks)
        function getDefaultThoughts() {
            if (remoteConfig && remoteConfig.thoughts) {
                return [...remoteConfig.thoughts];
            }
            // If no Firebase data, return a single empty thought to show one empty field
            return [''];
        }
        function getDefaultResponses() {
            if (remoteConfig && remoteConfig.responses) {
                return [...remoteConfig.responses];
            }
            // If no Firebase data, return a single empty response
            return [''];
        }
        function getDefaultHeroText() {
            return remoteConfig && remoteConfig.heroText ? remoteConfig.heroText : '';
        }
        function getDefaultActions() {
            if (remoteConfig && remoteConfig.actions) {
                return remoteConfig.actions.map(a => ({...a}));
            }
            // If no Firebase data, return a single empty action
            return [{ type: 'none', url: '', logo: '', linkText: 'Click here' }];
        }
        function getDefaultActiveStates() {
            if (remoteConfig && remoteConfig.activeStates) {
                return [...remoteConfig.activeStates];
            }
            // If no Firebase data, return a single active state
            return [true];
        }
        function getDefaultYesRedirectIndices() {
            if (remoteConfig && remoteConfig.yesRedirectIndices) {
                return [...remoteConfig.yesRedirectIndices];
            }
            // If no Firebase data, return a single empty redirect
            return [''];
        }
        function getDefaultNoRedirectIndices() {
            if (remoteConfig && remoteConfig.noRedirectIndices) {
                return [...remoteConfig.noRedirectIndices];
            }
            // If no Firebase data, return a single empty redirect
            return [''];
        }
        function getDefaultChoiceATexts() {
            if (remoteConfig && remoteConfig.choiceATexts) {
                return [...remoteConfig.choiceATexts];
            }
            // If no Firebase data, return a single empty text (defaults to "Yes")
            return [''];
        }
        function getDefaultChoiceBTexts() {
            if (remoteConfig && remoteConfig.choiceBTexts) {
                return [...remoteConfig.choiceBTexts];
            }
            // If no Firebase data, return a single empty text (defaults to "No")
            return [''];
        }
        function getDefaultChoiceAActions() {
            if (remoteConfig && remoteConfig.choiceAActions) {
                return remoteConfig.choiceAActions.map(a => ({...a}));
            }
            // If no Firebase data, return a single default choice action
            return [{ type: 'none', endAction: false }];
        }
        function getDefaultChoiceBActions() {
            if (remoteConfig && remoteConfig.choiceBActions) {
                return remoteConfig.choiceBActions.map(a => ({...a}));
            }
            // If no Firebase data, return a single default choice action
            return [{ type: 'none', endAction: false }];
        }
        function getDefaultTypingSpeeds() {
            if (remoteConfig && remoteConfig.typingSpeeds) {
                return [...remoteConfig.typingSpeeds];
            }
            // If no Firebase data, return a single default speed (100ms - middle of 10-200 range)
            return [100];
        }
        function getDefaultMoods() {
            if (remoteConfig && remoteConfig.moods) {
                return [...remoteConfig.moods];
            }
            // If no Firebase data, return a single default mood
            return ['stable'];
        }
        function getDefaultSettings() {
            if (remoteConfig && remoteConfig.settings) {
                return remoteConfig.settings;
            }
            // Default settings if no Firebase data (per-card typingSpeed and mood are now separate arrays)
            return {
                choiceButtonsEnabled: false,
                matrixFadeDuration: 1.5,
                earthquakeDuration: 1.5,
                curtainDuration: 4,
                earthquakeEnabled: true,
                bootSequenceEnabled: true,
                randomizeEnabled: false
            };
        }
        function getDefaultSecretCommands() {
            if (remoteConfig && remoteConfig.secretCommands) {
                return remoteConfig.secretCommands.map(cmd => ({...cmd}));
            }
            // If no Firebase data, return empty array (user can add commands)
            return [];
        }
        function getDefaultBuildersMedia() {
            return remoteConfig && remoteConfig.buildersMedia ? {...remoteConfig.buildersMedia} : { type: 'image', url: '' };
        }
        function getDefaultBootScript() {
            return remoteConfig && remoteConfig.bootScript ? remoteConfig.bootScript : 'CORE_INIT: OK\nMEM_LOAD: 1024KB\nDRV_MOUNT: /assets\nNET_STACK: READY\nSYS_CHECK: COMPLETE';
        }
        function getDefaultBackgroundImageUrl() {
            return remoteConfig && remoteConfig.backgroundImageUrl ? remoteConfig.backgroundImageUrl : '';
        }
        function getDefaultIntermissionImageUrl() {
            return remoteConfig && remoteConfig.intermissionImageUrl ? remoteConfig.intermissionImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }
        function getDefaultTechDifficultyImageUrl() {
            return remoteConfig && remoteConfig.techDifficultyImageUrl ? remoteConfig.techDifficultyImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }
        function getDefaultFinImageUrl() {
            return remoteConfig && remoteConfig.finImageUrl ? remoteConfig.finImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }

        function getDefaultMeltdownMessage() {
            return remoteConfig && remoteConfig.meltdownMessage ? remoteConfig.meltdownMessage : 'CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN';
        }

        function getDefaultMeltdownAudioURL() {
            return remoteConfig && remoteConfig.meltdownAudioURL ? remoteConfig.meltdownAudioURL : '';
        }

        function getDefaultMst3kOverlayURL() {
            return remoteConfig && remoteConfig.mst3kOverlayURL ? remoteConfig.mst3kOverlayURL : '';
        }

        function getDefaultMst3kGlowIntensity() {
            return remoteConfig && remoteConfig.mst3kGlowIntensity !== undefined ? remoteConfig.mst3kGlowIntensity : 0.6;
        }

        function getDefaultTheaterFrameURL() {
            return remoteConfig && remoteConfig.theaterFrameURL ? remoteConfig.theaterFrameURL : '';
        }

        function getDefaultGlobalAmbientAudioURL() {
            return remoteConfig && remoteConfig.globalAmbientAudioURL ? remoteConfig.globalAmbientAudioURL : '';
        }

        function getDefaultSceneAudioOverrides() {
            if (remoteConfig && remoteConfig.sceneAudioOverrides) {
                return remoteConfig.sceneAudioOverrides.map(s => ({...s}));
            }
            // If no Firebase data, return empty array
            return [];
        }

        // Fetch remote configuration from Firebase
        async function fetchRemoteConfig() {
            return new Promise((resolve) => {
                const configRef = ref(db, 'siteConfig');

                onValue(configRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        remoteConfig = data;
                        console.log('Firebase config loaded successfully');
                    } else {
                        console.warn('No config data found in Firebase');
                        remoteConfig = null;
                    }
                    resolve();
                }, (error) => {
                    console.error('Failed to load Firebase config:', error);
                    remoteConfig = null;
                    resolve();
                }, { onlyOnce: true });
            });
        }

        // App version - must match index.html. Increment to force localStorage data refresh
        const APP_VERSION = '1.0.6';
        const DATA_VERSION_KEY = 'imaginecraft_app_version';

        // Check and handle data version mismatch
        function checkDataVersion() {
            try {
                const storedVersion = localStorage.getItem(DATA_VERSION_KEY);
                if (storedVersion !== APP_VERSION) {
                    console.log('App version mismatch. Stored:', storedVersion, 'Current:', APP_VERSION);
                    console.log('Clearing cached data to load fresh defaults...');
                    // Clear all imaginecraft data keys
                    const keysToRemove = [
                        'imaginecraft_thoughts',
                        'imaginecraft_responses',
                        'imaginecraft_hero_text',
                        'imaginecraft_actions',
                        'imaginecraft_active_states',
                        'imaginecraft_randomize_enabled',
                        'imaginecraft_typing_speed',
                        'imaginecraft_choice_buttons_enabled',
                        'imaginecraft_matrix_fade_duration',
                        'imaginecraft_earthquake_duration',
                        'imaginecraft_earthquake_enabled',
                        'imaginecraft_boot_sequence_enabled',
                        'imaginecraft_system_mood',
                        'imaginecraft_secret_commands',
                        'imaginecraft_builders_media'
                    ];
                    keysToRemove.forEach(function(key) {
                        localStorage.removeItem(key);
                    });
                    // Set new version
                    localStorage.setItem(DATA_VERSION_KEY, APP_VERSION);
                    return true; // Data was cleared
                }
                return false; // Version matched, no clear needed
            } catch (e) {
                console.warn('Failed to check data version:', e);
                return false;
            }
        }

        // Initialize the app after fetching remote config
        async function initializeWithRemoteConfig() {
            await fetchRemoteConfig();
            checkDataVersion();
        }

        // Start fetching config immediately
        const configPromise = initializeWithRemoteConfig();

        // Action types
        const ACTION_TYPES = [
            { value: 'none', label: 'None' },
            { value: 'video', label: 'Video' },
            { value: 'image', label: 'Static Image' },
            { value: 'logo', label: 'Logo' },
            { value: 'matrix', label: 'The Matrix' },
            { value: 'audio', label: 'Audio Clip' },
            { value: 'capture-name', label: 'Capture Name' },
            { value: 'trigger-fin', label: 'Trigger Fin (The End)' },
            { value: 'system-meltdown', label: 'System Meltdown' },
            { value: 'prism-fracture', label: 'Prism Fracture' },
            { value: 'chrono-static', label: 'Chrono-Static' },
            { value: 'event-horizon', label: 'Event Horizon' },
            { value: 'hypnotic-spiral', label: 'Hypnotic Spiral (Twilight Zone)' }
        ];

        // Secret command action types
        const SECRET_ACTION_TYPES = [
            { value: 'earthquake', label: 'Trigger Earthquake & Split' },
            { value: 'matrix', label: 'Toggle Matrix Animation' },
            { value: 'warp', label: 'Star Wars Hyperspace Jump' },
            { value: 'transparent', label: 'Transparent (Reveal Builders)' },
            { value: 'redirect', label: 'Redirect to URL' }
        ];

        // CYOA choice-specific action types (for End Action buttons)
        const CHOICE_ACTION_TYPES = [
            { value: 'none', label: 'None (Continue Story)' },
            { value: 'trigger-fin', label: 'Trigger Fin (The End)' },
            { value: 'system-meltdown', label: 'System Meltdown' },
            { value: 'matrix', label: 'The Matrix' },
            { value: 'supernova-flash', label: 'Supernova Flash' },
            { value: 'spaghettify', label: 'Spaghettify (Black Hole)' },
            { value: 'hull-breach', label: 'Hull Breach' },
            { value: 'oxygen-depletion', label: 'Oxygen Depletion' },
            { value: 'recursive-reality', label: 'Recursive Reality (Infinity Mirror)' },
            { value: 'quantum-leak', label: 'Quantum Leak (Rainbow Liquid)' },
            { value: 'prism-fracture', label: 'Prism Fracture' },
            { value: 'chrono-static', label: 'Chrono-Static' },
            { value: 'event-horizon', label: 'Event Horizon' },
            { value: 'hypnotic-spiral', label: 'Hypnotic Spiral (Twilight Zone)' }
        ];

        // Current data (will be initialized after config loads)
        let currentThoughts = [];
        let currentResponses = [];
        let currentHeroText = '';
        let currentActions = [];
        let currentActiveStates = [];
        let currentYesRedirectIndices = [];
        let currentNoRedirectIndices = [];
        let currentChoiceATexts = [];
        let currentChoiceBTexts = [];
        let currentChoiceAActions = [];
        let currentChoiceBActions = [];
        let currentTypingSpeeds = [];  // Per-card typing speeds (10-200ms)
        let currentMoods = [];          // Per-card AI moods (stable, glitchy, urgent)
        let currentRandomizeEnabled = false;
        let currentChoiceButtonsEnabled = false;
        let currentMatrixFadeDuration = 1.5;
        let currentEarthquakeDuration = 1.5;
        let currentCurtainDuration = 4;
        let currentEarthquakeEnabled = true;
        let currentBootSequenceEnabled = true;
        let currentSecretCommands = [];
        let currentBuildersMedia = { type: 'image', url: '' };
        let currentBootScript = 'CORE_INIT: OK\nMEM_LOAD: 1024KB\nDRV_MOUNT: /assets\nNET_STACK: READY\nSYS_CHECK: COMPLETE';
        let currentBackgroundImageUrl = '';
        let currentIntermissionImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentTechDifficultyImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentFinImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentMeltdownMessage = 'CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN';
        let currentMeltdownAudioURL = '';
        let currentMst3kOverlayURL = '';
        let currentMst3kGlowIntensity = 0.6;
        let currentTheaterFrameURL = '';
        let currentGlobalAmbientAudioURL = '';
        let currentSceneAudioOverrides = [];  // Per-card audio overrides: { url: '', loop: true }

        // Initialize default actions
        function initDefaultActions() {
            return getDefaultActions();
        }

        // Load data from config.json (no localStorage)
        function loadFromConfig() {
            const defaults = getDefaultSettings();
            try {
                currentThoughts = getDefaultThoughts();
                currentResponses = getDefaultResponses();
                currentHeroText = getDefaultHeroText();
                currentActions = initDefaultActions();
                currentActiveStates = getDefaultActiveStates();
                currentYesRedirectIndices = getDefaultYesRedirectIndices();
                currentNoRedirectIndices = getDefaultNoRedirectIndices();
                currentChoiceATexts = getDefaultChoiceATexts();
                currentChoiceBTexts = getDefaultChoiceBTexts();
                currentChoiceAActions = getDefaultChoiceAActions();
                currentChoiceBActions = getDefaultChoiceBActions();
                currentTypingSpeeds = getDefaultTypingSpeeds();
                currentMoods = getDefaultMoods();
                currentRandomizeEnabled = defaults.randomizeEnabled || false;
                currentChoiceButtonsEnabled = defaults.choiceButtonsEnabled || false;
                currentMatrixFadeDuration = defaults.matrixFadeDuration || 1.5;
                currentEarthquakeDuration = defaults.earthquakeDuration || 1.5;
                currentCurtainDuration = defaults.curtainDuration || 4;
                currentEarthquakeEnabled = defaults.earthquakeEnabled !== undefined ? defaults.earthquakeEnabled : true;
                currentBootSequenceEnabled = defaults.bootSequenceEnabled !== undefined ? defaults.bootSequenceEnabled : true;
                currentSecretCommands = getDefaultSecretCommands();
                currentBuildersMedia = getDefaultBuildersMedia();
                currentBootScript = getDefaultBootScript();
                currentBackgroundImageUrl = getDefaultBackgroundImageUrl();
                currentIntermissionImageUrl = getDefaultIntermissionImageUrl();
                currentTechDifficultyImageUrl = getDefaultTechDifficultyImageUrl();
                currentFinImageUrl = getDefaultFinImageUrl();
                currentMeltdownMessage = getDefaultMeltdownMessage();
                currentMeltdownAudioURL = getDefaultMeltdownAudioURL();
                currentMst3kOverlayURL = getDefaultMst3kOverlayURL();
                currentMst3kGlowIntensity = getDefaultMst3kGlowIntensity();
                currentTheaterFrameURL = getDefaultTheaterFrameURL();
                currentGlobalAmbientAudioURL = getDefaultGlobalAmbientAudioURL();
                currentSceneAudioOverrides = getDefaultSceneAudioOverrides();

                // Ensure all actions exist (based on thought count)
                const thoughtCount = currentThoughts.length;
                while (currentActions.length < thoughtCount) {
                    currentActions.push({ type: 'none', url: '', logo: '', linkText: 'Click here' });
                }
                // Ensure all active states exist (default to true)
                while (currentActiveStates.length < thoughtCount) {
                    currentActiveStates.push(true);
                }
                // Ensure all redirect indices exist (default to empty string)
                while (currentYesRedirectIndices.length < thoughtCount) {
                    currentYesRedirectIndices.push('');
                }
                while (currentNoRedirectIndices.length < thoughtCount) {
                    currentNoRedirectIndices.push('');
                }
                // Ensure all choice texts exist (default to empty string for Yes/No defaults)
                while (currentChoiceATexts.length < thoughtCount) {
                    currentChoiceATexts.push('');
                }
                while (currentChoiceBTexts.length < thoughtCount) {
                    currentChoiceBTexts.push('');
                }
                // Ensure all choice actions exist (default to none, no end action)
                while (currentChoiceAActions.length < thoughtCount) {
                    currentChoiceAActions.push({ type: 'none', endAction: false });
                }
                while (currentChoiceBActions.length < thoughtCount) {
                    currentChoiceBActions.push({ type: 'none', endAction: false });
                }
                // Ensure all per-card typing speeds exist (default to 100ms - middle of 10-200 range)
                while (currentTypingSpeeds.length < thoughtCount) {
                    currentTypingSpeeds.push(100);
                }
                // Ensure all per-card moods exist (default to 'stable')
                while (currentMoods.length < thoughtCount) {
                    currentMoods.push('stable');
                }
                // Ensure all per-card scene audio overrides exist (default to empty)
                while (currentSceneAudioOverrides.length < thoughtCount) {
                    currentSceneAudioOverrides.push({ url: '', loop: true });
                }
            } catch (e) {
                console.warn('Failed to load from config:', e);
                currentThoughts = getDefaultThoughts();
                currentResponses = getDefaultResponses();
                currentHeroText = getDefaultHeroText();
                currentActions = initDefaultActions();
                currentActiveStates = getDefaultActiveStates();
                currentYesRedirectIndices = getDefaultYesRedirectIndices();
                currentNoRedirectIndices = getDefaultNoRedirectIndices();
                currentChoiceATexts = getDefaultChoiceATexts();
                currentChoiceBTexts = getDefaultChoiceBTexts();
                currentChoiceAActions = getDefaultChoiceAActions();
                currentChoiceBActions = getDefaultChoiceBActions();
                currentTypingSpeeds = getDefaultTypingSpeeds();
                currentMoods = getDefaultMoods();
                currentRandomizeEnabled = defaults.randomizeEnabled || false;
                currentChoiceButtonsEnabled = defaults.choiceButtonsEnabled || false;
                currentMatrixFadeDuration = defaults.matrixFadeDuration || 1.5;
                currentEarthquakeDuration = defaults.earthquakeDuration || 1.5;
                currentCurtainDuration = defaults.curtainDuration || 4;
                currentEarthquakeEnabled = defaults.earthquakeEnabled !== undefined ? defaults.earthquakeEnabled : true;
                currentBootSequenceEnabled = defaults.bootSequenceEnabled !== undefined ? defaults.bootSequenceEnabled : true;
                currentSecretCommands = getDefaultSecretCommands();
                currentBuildersMedia = getDefaultBuildersMedia();
                currentBootScript = getDefaultBootScript();
                currentBackgroundImageUrl = getDefaultBackgroundImageUrl();
                currentIntermissionImageUrl = getDefaultIntermissionImageUrl();
                currentTechDifficultyImageUrl = getDefaultTechDifficultyImageUrl();
                currentFinImageUrl = getDefaultFinImageUrl();
                currentMeltdownMessage = getDefaultMeltdownMessage();
                currentMeltdownAudioURL = getDefaultMeltdownAudioURL();
                currentMst3kOverlayURL = getDefaultMst3kOverlayURL();
                currentMst3kGlowIntensity = getDefaultMst3kGlowIntensity();
                currentTheaterFrameURL = getDefaultTheaterFrameURL();
                currentGlobalAmbientAudioURL = getDefaultGlobalAmbientAudioURL();
                currentSceneAudioOverrides = getDefaultSceneAudioOverrides();
            }
        }

        // Render full dashboard
        function renderDashboard() {
            // Update hero text field
            const heroInput = document.getElementById('heroText');
            if (heroInput) {
                heroInput.value = currentHeroText;
            }

            // Update choice buttons toggle
            const choiceButtonsToggle = document.getElementById('choiceButtonsToggle');
            const choiceButtonsToggleLabel = document.getElementById('choiceButtonsToggleLabel');
            if (choiceButtonsToggle && choiceButtonsToggleLabel) {
                choiceButtonsToggle.checked = currentChoiceButtonsEnabled;
                choiceButtonsToggleLabel.textContent = currentChoiceButtonsEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                choiceButtonsToggle.addEventListener('change', function() {
                    choiceButtonsToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update matrix fade duration slider
            const matrixFadeSlider = document.getElementById('matrixFadeSlider');
            const matrixFadeValue = document.getElementById('matrixFadeValue');
            if (matrixFadeSlider && matrixFadeValue) {
                matrixFadeSlider.value = currentMatrixFadeDuration;
                matrixFadeValue.textContent = currentMatrixFadeDuration;

                // Add event listener for real-time value update
                matrixFadeSlider.addEventListener('input', function() {
                    matrixFadeValue.textContent = this.value;
                });
            }

            // Update earthquake duration slider
            const earthquakeDurationSlider = document.getElementById('earthquakeDurationSlider');
            const earthquakeDurationValue = document.getElementById('earthquakeDurationValue');
            if (earthquakeDurationSlider && earthquakeDurationValue) {
                earthquakeDurationSlider.value = currentEarthquakeDuration;
                earthquakeDurationValue.textContent = currentEarthquakeDuration;

                // Add event listener for real-time value update
                earthquakeDurationSlider.addEventListener('input', function() {
                    earthquakeDurationValue.textContent = this.value;
                });
            }

            // Update curtain duration slider
            const curtainDurationSlider = document.getElementById('curtainDurationSlider');
            const curtainDurationValue = document.getElementById('curtainDurationValue');
            if (curtainDurationSlider && curtainDurationValue) {
                curtainDurationSlider.value = currentCurtainDuration;
                curtainDurationValue.textContent = currentCurtainDuration;

                // Add event listener for real-time value update
                curtainDurationSlider.addEventListener('input', function() {
                    curtainDurationValue.textContent = this.value;
                });
            }

            // Update earthquake toggle
            const earthquakeToggle = document.getElementById('earthquakeToggle');
            const earthquakeToggleLabel = document.getElementById('earthquakeToggleLabel');
            if (earthquakeToggle && earthquakeToggleLabel) {
                earthquakeToggle.checked = currentEarthquakeEnabled;
                earthquakeToggleLabel.textContent = currentEarthquakeEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                earthquakeToggle.addEventListener('change', function() {
                    earthquakeToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update randomize toggle
            const randomizeToggle = document.getElementById('randomizeToggle');
            if (randomizeToggle) {
                randomizeToggle.checked = currentRandomizeEnabled;
            }

            // Update boot sequence toggle
            const bootSequenceToggle = document.getElementById('bootSequenceToggle');
            const bootSequenceToggleLabel = document.getElementById('bootSequenceToggleLabel');
            if (bootSequenceToggle && bootSequenceToggleLabel) {
                bootSequenceToggle.checked = currentBootSequenceEnabled;
                bootSequenceToggleLabel.textContent = currentBootSequenceEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                bootSequenceToggle.addEventListener('change', function() {
                    bootSequenceToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update builders media fields
            const buildersMediaType = document.getElementById('buildersMediaType');
            const buildersMediaUrl = document.getElementById('buildersMediaUrl');
            if (buildersMediaType && buildersMediaUrl) {
                buildersMediaType.value = currentBuildersMedia.type || 'image';
                buildersMediaUrl.value = currentBuildersMedia.url || '';
            }

            // Update boot script textarea
            const bootScriptTextarea = document.getElementById('bootScriptTextarea');
            if (bootScriptTextarea) {
                bootScriptTextarea.value = currentBootScript;
            }

            // Update background image URL
            const backgroundImageUrlInput = document.getElementById('backgroundImageUrl');
            if (backgroundImageUrlInput) {
                backgroundImageUrlInput.value = currentBackgroundImageUrl;
            }

            // Update cinematic state image URLs
            const intermissionImageUrlInput = document.getElementById('intermissionImageUrl');
            if (intermissionImageUrlInput) {
                intermissionImageUrlInput.value = currentIntermissionImageUrl;
            }
            const techDifficultyImageUrlInput = document.getElementById('techDifficultyImageUrl');
            if (techDifficultyImageUrlInput) {
                techDifficultyImageUrlInput.value = currentTechDifficultyImageUrl;
            }
            const finImageUrlInput = document.getElementById('finImageUrl');
            if (finImageUrlInput) {
                finImageUrlInput.value = currentFinImageUrl;
            }

            // Update meltdown configuration
            const meltdownMessageInput = document.getElementById('meltdownMessage');
            if (meltdownMessageInput) {
                meltdownMessageInput.value = currentMeltdownMessage;
            }
            const meltdownAudioURLInput = document.getElementById('meltdownAudioURL');
            if (meltdownAudioURLInput) {
                meltdownAudioURLInput.value = currentMeltdownAudioURL;
            }

            // Update MST3K overlay URL
            const mst3kOverlayURLInput = document.getElementById('mst3kOverlayURL');
            if (mst3kOverlayURLInput) {
                mst3kOverlayURLInput.value = currentMst3kOverlayURL;
            }

            // Update MST3K glow intensity
            const mst3kGlowIntensityInput = document.getElementById('mst3kGlowIntensity');
            if (mst3kGlowIntensityInput) {
                mst3kGlowIntensityInput.value = currentMst3kGlowIntensity;
            }

            // Update Theater Frame URL
            const theaterFrameURLInput = document.getElementById('theaterFrameURL');
            if (theaterFrameURLInput) {
                theaterFrameURLInput.value = currentTheaterFrameURL;
            }

            // Update Global Ambient Audio URL
            const globalAmbientAudioURLInput = document.getElementById('globalAmbientAudioURL');
            if (globalAmbientAudioURLInput) {
                globalAmbientAudioURLInput.value = currentGlobalAmbientAudioURL;
            }

            renderThoughtCards();
            renderSecretCommands();
        }

        // Render secret commands list
        function renderSecretCommands() {
            const list = document.getElementById('secretCommandsList');
            if (!list) return;

            list.innerHTML = '';

            currentSecretCommands.forEach((command, index) => {
                const card = document.createElement('div');
                card.className = 'secret-command-card';
                card.id = `secret-command-${index}`;

                const showUrlField = command.action === 'redirect';

                card.innerHTML = `
                    <div class="secret-command-header">
                        <div class="secret-command-keyword">
                            <span class="keyword-badge">${escapeHtml(command.keyword)}</span>
                        </div>
                        <div class="secret-command-controls">
                            <div class="active-toggle-container">
                                <input type="checkbox" id="cmd-enabled-${index}" class="active-checkbox" ${command.enabled ? 'checked' : ''} onchange="handleCommandEnabledChange(${index})">
                                <label for="cmd-enabled-${index}" class="active-label">Enabled</label>
                            </div>
                            <button type="button" class="delete-command-btn" onclick="deleteSecretCommand(${index})">Delete</button>
                        </div>
                    </div>
                    <div class="secret-command-body">
                        <div class="form-group">
                            <label>Keyword</label>
                            <input type="text" id="cmd-keyword-${index}" value="${escapeHtml(command.keyword)}" placeholder="e.g., FOREST" onchange="updateCommandKeyword(${index})" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Action Type</label>
                            <select id="cmd-action-${index}" onchange="handleCommandActionChange(${index})">
                                ${SECRET_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${command.action === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group url-field" id="cmd-url-group-${index}" style="${showUrlField ? '' : 'display: none;'}">
                            <label>Redirect URL</label>
                            <input type="text" id="cmd-url-${index}" value="${escapeHtml(command.url || '')}" placeholder="e.g., admin.html or https://..." onchange="updateCommandUrl(${index})">
                        </div>
                        <div class="form-group" style="grid-column: ${showUrlField ? '1' : '1 / -1'};">
                            <label>Description (optional)</label>
                            <input type="text" id="cmd-desc-${index}" value="${escapeHtml(command.description || '')}" placeholder="Describe what this command does" onchange="updateCommandDescription(${index})">
                        </div>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        // Handle command enabled checkbox change
        function handleCommandEnabledChange(index) {
            const checkbox = document.getElementById(`cmd-enabled-${index}`);
            if (checkbox) {
                currentSecretCommands[index].enabled = checkbox.checked;
            }
        }

        // Handle command action type change
        function handleCommandActionChange(index) {
            const select = document.getElementById(`cmd-action-${index}`);
            const urlGroup = document.getElementById(`cmd-url-group-${index}`);

            if (select) {
                currentSecretCommands[index].action = select.value;

                // Show/hide URL field based on action type
                if (urlGroup) {
                    urlGroup.style.display = select.value === 'redirect' ? '' : 'none';
                }

                // Update the keyword badge display
                const keywordInput = document.getElementById(`cmd-keyword-${index}`);
                if (keywordInput) {
                    const badge = document.querySelector(`#secret-command-${index} .keyword-badge`);
                    if (badge) {
                        badge.textContent = keywordInput.value.toUpperCase();
                    }
                }
            }
        }

        // Update command keyword
        function updateCommandKeyword(index) {
            const input = document.getElementById(`cmd-keyword-${index}`);
            if (input) {
                const keyword = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                input.value = keyword;
                currentSecretCommands[index].keyword = keyword;

                // Update the badge
                const badge = document.querySelector(`#secret-command-${index} .keyword-badge`);
                if (badge) {
                    badge.textContent = keyword;
                }
            }
        }

        // Update command URL
        function updateCommandUrl(index) {
            const input = document.getElementById(`cmd-url-${index}`);
            if (input) {
                currentSecretCommands[index].url = input.value;
            }
        }

        // Update command description
        function updateCommandDescription(index) {
            const input = document.getElementById(`cmd-desc-${index}`);
            if (input) {
                currentSecretCommands[index].description = input.value;
            }
        }

        // Add new secret command
        function addNewSecretCommand() {
            const newCommand = {
                keyword: 'NEWCMD',
                action: 'redirect',
                url: '',
                enabled: true,
                description: ''
            };

            currentSecretCommands.push(newCommand);
            renderSecretCommands();

            // Scroll to new command and focus keyword input
            setTimeout(() => {
                const newIndex = currentSecretCommands.length - 1;
                const newCard = document.getElementById(`secret-command-${newIndex}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const keywordInput = document.getElementById(`cmd-keyword-${newIndex}`);
                    if (keywordInput) {
                        keywordInput.focus();
                        keywordInput.select();
                    }
                }
            }, 100);
        }

        // Delete secret command
        function deleteSecretCommand(index) {
            if (confirm('Are you sure you want to delete this secret command?')) {
                currentSecretCommands.splice(index, 1);
                renderSecretCommands();
            }
        }

        // Add new thought
        function addNewThought() {
            const newIndex = currentThoughts.length;

            // Add empty thought with defaults
            currentThoughts.push('');
            currentResponses.push('');
            currentActions.push({ type: 'none', url: '', logo: '', linkText: 'Click here' });
            currentActiveStates.push(true);
            currentYesRedirectIndices.push('');
            currentNoRedirectIndices.push('');
            currentChoiceATexts.push('');
            currentChoiceBTexts.push('');
            currentChoiceAActions.push({ type: 'none', endAction: false });
            currentChoiceBActions.push({ type: 'none', endAction: false });
            currentTypingSpeeds.push(100);  // Default to 100ms (middle of 10-200 range)
            currentMoods.push('stable');     // Default to 'stable' mood
            currentSceneAudioOverrides.push({ url: '', loop: true });  // Default to no override

            renderThoughtCards();

            // Scroll to new thought and focus input
            setTimeout(() => {
                const newCard = document.getElementById(`thought-card-${newIndex}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const thoughtInput = document.getElementById(`thought-${newIndex}`);
                    if (thoughtInput) {
                        thoughtInput.focus();
                    }
                }
            }, 100);
        }

        // Delete thought
        function deleteThought(index) {
            if (currentThoughts.length <= 1) {
                alert('You must have at least one thought.');
                return;
            }

            if (confirm('Are you sure you want to delete this thought?')) {
                currentThoughts.splice(index, 1);
                currentResponses.splice(index, 1);
                currentActions.splice(index, 1);
                currentActiveStates.splice(index, 1);
                currentYesRedirectIndices.splice(index, 1);
                currentNoRedirectIndices.splice(index, 1);
                currentChoiceATexts.splice(index, 1);
                currentChoiceBTexts.splice(index, 1);
                currentChoiceAActions.splice(index, 1);
                currentChoiceBActions.splice(index, 1);
                currentTypingSpeeds.splice(index, 1);
                currentMoods.splice(index, 1);
                currentSceneAudioOverrides.splice(index, 1);
                renderThoughtCards();
            }
        }

        // Update mood preview
        function updateMoodPreview(mood) {
            const moodPreview = document.getElementById('moodPreview');
            if (!moodPreview) return;

            // Remove all mood classes
            moodPreview.classList.remove('stable', 'glitchy', 'urgent');

            // Add the selected mood class
            moodPreview.classList.add(mood);
        }

        // Render thought cards - Simplified CYOA layout with scene-specific atmosphere
        function renderThoughtCards() {
            const grid = document.getElementById('thoughtsGrid');
            grid.innerHTML = '';

            // Iterate over actual thoughts array length
            const thoughtCount = currentThoughts.length;
            for (let i = 0; i < thoughtCount; i++) {
                const isActive = currentActiveStates[i] !== false; // Default to true
                const choiceAAction = currentChoiceAActions[i] || { type: 'none', endAction: false };
                const choiceBAction = currentChoiceBActions[i] || { type: 'none', endAction: false };
                const typingSpeed = currentTypingSpeeds[i] !== undefined ? currentTypingSpeeds[i] : 100;
                const mood = currentMoods[i] || 'stable';
                const card = document.createElement('div');
                card.className = 'thought-card' + (isActive ? '' : ' inactive');
                card.id = `thought-card-${i}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-number">${i + 1}</span>
                        <div class="card-controls">
                            <div class="active-toggle-container">
                                <input type="checkbox" id="active-${i}" class="active-checkbox" ${isActive ? 'checked' : ''} onchange="handleActiveChange(${i})">
                                <label for="active-${i}" class="active-label">Active</label>
                            </div>
                            <button type="button" class="delete-command-btn" onclick="deleteThought(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Story Text</label>
                        <small style="display: block; color: rgba(31, 31, 31, 0.6); margin-bottom: 0.5rem; font-size: 0.8rem;">Use &lt;&lt;name&gt;&gt; to insert the user's name</small>
                        <textarea id="thought-${i}" class="thought-textarea" rows="10" placeholder="Enter story paragraph... Use {misspelled} for backspace effect and <<name>> for user name.">${escapeHtml(currentThoughts[i] || '')}</textarea>
                    </div>

                    <!-- Scene Atmosphere Controls -->
                    <div style="background: rgba(91, 95, 234, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--accent);">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: var(--accent);">Scene Atmosphere</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Typing Speed (10ms-200ms)</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="range" id="typing-speed-${i}" min="10" max="200" value="${typingSpeed}" class="speed-slider" style="flex: 1;" oninput="updateTypingSpeedDisplay(${i})">
                                    <span id="typing-speed-value-${i}" style="min-width: 50px; text-align: right; font-weight: 600; color: var(--accent);">${typingSpeed}ms</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                                    <span>Instant</span>
                                    <span>Slow</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>AI System Mood</label>
                                <select id="mood-${i}" class="mood-select">
                                    <option value="stable" ${mood === 'stable' ? 'selected' : ''}>Stable - Steady rhythm</option>
                                    <option value="glitchy" ${mood === 'glitchy' ? 'selected' : ''}>Glitchy - Irregular typing</option>
                                    <option value="urgent" ${mood === 'urgent' ? 'selected' : ''}>Urgent - Red, fast typing</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(91, 95, 234, 0.2);">
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <label>Override Ambient Audio URL</label>
                                <input type="url" id="scene-audio-${i}" value="${escapeHtml(currentSceneAudioOverrides[i]?.url || '')}" placeholder="https://example.com/scene-audio.mp3">
                            </div>
                            <div class="active-toggle-container" style="margin-top: 0.5rem;">
                                <input type="checkbox" id="scene-audio-loop-${i}" class="active-checkbox" ${currentSceneAudioOverrides[i]?.loop !== false ? 'checked' : ''}>
                                <label for="scene-audio-loop-${i}" class="active-label">Loop Audio</label>
                            </div>
                            <p style="font-size: 0.7rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                                When set, this audio will cross-fade in when entering this scene. Leave empty to use global ambient.
                            </p>
                        </div>
                    </div>

                    <!-- Choice A Section -->
                    <div style="background: rgba(52, 255, 53, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #34ff35;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: #34ff35;">Choice A</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Button Label (blank = "Yes")</label>
                            <input type="text" id="choice-a-text-${i}" value="${escapeHtml(currentChoiceATexts[i] || '')}" placeholder="e.g., Get in the vehicle">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Jump to Index (blank = next)</label>
                            <input type="number" id="yes-redirect-${i}" value="${escapeHtml(currentYesRedirectIndices[i] || '')}" placeholder="e.g., 3" min="1" max="${thoughtCount}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Action Type</label>
                            <select id="choice-a-action-type-${i}" onchange="handleChoiceActionChange('A', ${i})">
                                ${CHOICE_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${choiceAAction.type === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="active-toggle-container" id="choice-a-end-action-${i}" style="${choiceAAction.type === 'none' ? 'display: none;' : ''}">
                            <input type="checkbox" id="choice-a-end-${i}" class="active-checkbox" ${choiceAAction.endAction ? 'checked' : ''}>
                            <label for="choice-a-end-${i}" class="active-label" style="color: #ef4444;">End Action (stops story)</label>
                        </div>
                    </div>

                    <!-- Choice B Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 3px solid rgba(255, 255, 255, 0.3);">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: rgba(31, 31, 31, 0.8);">Choice B</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Button Label (blank = "No")</label>
                            <input type="text" id="choice-b-text-${i}" value="${escapeHtml(currentChoiceBTexts[i] || '')}" placeholder="e.g., Keep running toward the lights">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Jump to Index (blank = next)</label>
                            <input type="number" id="no-redirect-${i}" value="${escapeHtml(currentNoRedirectIndices[i] || '')}" placeholder="e.g., 5" min="1" max="${thoughtCount}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Action Type</label>
                            <select id="choice-b-action-type-${i}" onchange="handleChoiceActionChange('B', ${i})">
                                ${CHOICE_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${choiceBAction.type === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="active-toggle-container" id="choice-b-end-action-${i}" style="${choiceBAction.type === 'none' ? 'display: none;' : ''}">
                            <input type="checkbox" id="choice-b-end-${i}" class="active-checkbox" ${choiceBAction.endAction ? 'checked' : ''}>
                            <label for="choice-b-end-${i}" class="active-label" style="color: #ef4444;">End Action (stops story)</label>
                        </div>
                    </div>

                    <!-- Hidden fields for backward compatibility -->
                    <input type="hidden" id="response-${i}" value="${escapeHtml(currentResponses[i] || '')}">
                `;
                grid.appendChild(card);
            }
        }

        // Handle choice action type change (show/hide end action toggle)
        function handleChoiceActionChange(choice, index) {
            const select = document.getElementById(`choice-${choice.toLowerCase()}-action-type-${index}`);
            const endActionContainer = document.getElementById(`choice-${choice.toLowerCase()}-end-action-${index}`);

            if (select && endActionContainer) {
                const actionType = select.value;
                endActionContainer.style.display = actionType === 'none' ? 'none' : '';

                // Update the current data
                if (choice === 'A') {
                    if (!currentChoiceAActions[index]) {
                        currentChoiceAActions[index] = { type: 'none', endAction: false };
                    }
                    currentChoiceAActions[index].type = actionType;
                } else {
                    if (!currentChoiceBActions[index]) {
                        currentChoiceBActions[index] = { type: 'none', endAction: false };
                    }
                    currentChoiceBActions[index].type = actionType;
                }
            }
        }

        // Handle active checkbox change
        function handleActiveChange(index) {
            const checkbox = document.getElementById(`active-${index}`);
            const card = document.getElementById(`thought-card-${index}`);

            if (checkbox && card) {
                const isActive = checkbox.checked;
                currentActiveStates[index] = isActive;

                if (isActive) {
                    card.classList.remove('inactive');
                } else {
                    card.classList.add('inactive');
                }
            }
        }

        // Update typing speed display value in real-time
        function updateTypingSpeedDisplay(index) {
            const slider = document.getElementById(`typing-speed-${index}`);
            const display = document.getElementById(`typing-speed-value-${index}`);
            if (slider && display) {
                display.textContent = slider.value + 'ms';
            }
        }

        // Render action-specific fields
        function renderActionFields(index, action) {
            const linkTextField = `
                <div class="form-group">
                    <label>Link Text (shown in terminal)</label>
                    <input type="text" id="action-linktext-${index}" value="${escapeHtml(action.linkText || 'Click here')}" placeholder="Click here">
                </div>
            `;

            switch (action.type) {
                case 'video':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>YouTube URL</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                    `;
                case 'image':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://example.com/image.jpg">
                        </div>
                    `;
                case 'logo':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>ASCII Logo</label>
                            <textarea id="action-logo-${index}" placeholder="Enter ASCII art...">${escapeHtml(action.logo || '')}</textarea>
                        </div>
                    `;
                case 'audio':
                    return `
                        <div class="form-group">
                            <label>Audio Trigger Text (clickable link)</label>
                            <input type="text" id="action-linktext-${index}" value="${escapeHtml(action.linkText || 'Play Audio')}" placeholder="Play Audio">
                        </div>
                        <div class="form-group">
                            <label>Audio File URL (.wav, .mp3, etc.)</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://example.com/audio.wav">
                        </div>
                    `;
                case 'matrix':
                    return linkTextField;
                case 'contact':
                    return linkTextField;
                case 'system-meltdown':
                    return linkTextField;
                default:
                    return '';
            }
        }

        // Handle action type change
        function handleActionTypeChange(index) {
            const select = document.getElementById(`action-type-${index}`);
            const fieldsContainer = document.getElementById(`action-fields-${index}`);
            const actionType = select.value;

            // Update current action
            if (!currentActions[index]) {
                currentActions[index] = { type: 'none', url: '', logo: '', linkText: 'Click here' };
            }
            currentActions[index].type = actionType;

            // Show/hide fields container
            if (actionType === 'none') {
                fieldsContainer.classList.add('hidden');
                fieldsContainer.innerHTML = '';
            } else {
                fieldsContainer.classList.remove('hidden');
                fieldsContainer.innerHTML = renderActionFields(index, currentActions[index]);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Collect current form data into memory (no localStorage persistence)
        function collectCurrentFormData() {
            // Collect hero text
            const heroInput = document.getElementById('heroText');
            if (heroInput) {
                currentHeroText = heroInput.value || defaultHeroText;
            }

            // Collect choice buttons setting
            const choiceButtonsToggle = document.getElementById('choiceButtonsToggle');
            if (choiceButtonsToggle) {
                currentChoiceButtonsEnabled = choiceButtonsToggle.checked;
            }

            // Collect matrix fade duration
            const matrixFadeSlider = document.getElementById('matrixFadeSlider');
            if (matrixFadeSlider) {
                currentMatrixFadeDuration = parseFloat(matrixFadeSlider.value) || 1.5;
            }

            // Collect earthquake duration
            const earthquakeDurationSlider = document.getElementById('earthquakeDurationSlider');
            if (earthquakeDurationSlider) {
                currentEarthquakeDuration = parseFloat(earthquakeDurationSlider.value) || 1.5;
            }

            // Collect curtain duration
            const curtainDurationSlider = document.getElementById('curtainDurationSlider');
            if (curtainDurationSlider) {
                currentCurtainDuration = parseFloat(curtainDurationSlider.value) || 4;
            }

            // Collect earthquake transition setting
            const earthquakeToggle = document.getElementById('earthquakeToggle');
            if (earthquakeToggle) {
                currentEarthquakeEnabled = earthquakeToggle.checked;
            }

            // Collect randomize setting
            const randomizeToggle = document.getElementById('randomizeToggle');
            if (randomizeToggle) {
                currentRandomizeEnabled = randomizeToggle.checked;
            }

            // Collect boot sequence setting
            const bootSequenceToggle = document.getElementById('bootSequenceToggle');
            if (bootSequenceToggle) {
                currentBootSequenceEnabled = bootSequenceToggle.checked;
            }

            // Collect builders media settings
            const buildersMediaType = document.getElementById('buildersMediaType');
            const buildersMediaUrl = document.getElementById('buildersMediaUrl');
            if (buildersMediaType && buildersMediaUrl) {
                currentBuildersMedia = {
                    type: buildersMediaType.value,
                    url: buildersMediaUrl.value
                };
            }

            // Collect boot script
            const bootScriptTextarea = document.getElementById('bootScriptTextarea');
            if (bootScriptTextarea) {
                currentBootScript = bootScriptTextarea.value;
            }

            // Collect background image URL
            const backgroundImageUrlInput = document.getElementById('backgroundImageUrl');
            if (backgroundImageUrlInput) {
                currentBackgroundImageUrl = backgroundImageUrlInput.value;
            }

            // Collect cinematic state image URLs
            const intermissionImageUrlInput = document.getElementById('intermissionImageUrl');
            if (intermissionImageUrlInput) {
                currentIntermissionImageUrl = intermissionImageUrlInput.value;
            }
            const techDifficultyImageUrlInput = document.getElementById('techDifficultyImageUrl');
            if (techDifficultyImageUrlInput) {
                currentTechDifficultyImageUrl = techDifficultyImageUrlInput.value;
            }
            const finImageUrlInput = document.getElementById('finImageUrl');
            if (finImageUrlInput) {
                currentFinImageUrl = finImageUrlInput.value;
            }

            // Collect meltdown configuration
            const meltdownMessageInput = document.getElementById('meltdownMessage');
            if (meltdownMessageInput) {
                currentMeltdownMessage = meltdownMessageInput.value;
            }
            const meltdownAudioURLInput = document.getElementById('meltdownAudioURL');
            if (meltdownAudioURLInput) {
                currentMeltdownAudioURL = meltdownAudioURLInput.value;
            }

            // Collect MST3K overlay URL
            const mst3kOverlayURLInput = document.getElementById('mst3kOverlayURL');
            if (mst3kOverlayURLInput) {
                currentMst3kOverlayURL = mst3kOverlayURLInput.value;
            }

            // Collect MST3K glow intensity
            const mst3kGlowIntensityInput = document.getElementById('mst3kGlowIntensity');
            if (mst3kGlowIntensityInput) {
                currentMst3kGlowIntensity = parseFloat(mst3kGlowIntensityInput.value) || 0.6;
            }

            // Collect Theater Frame URL
            const theaterFrameURLInput = document.getElementById('theaterFrameURL');
            if (theaterFrameURLInput) {
                currentTheaterFrameURL = theaterFrameURLInput.value;
            }

            // Collect Global Ambient Audio URL
            const globalAmbientAudioURLInput = document.getElementById('globalAmbientAudioURL');
            if (globalAmbientAudioURLInput) {
                currentGlobalAmbientAudioURL = globalAmbientAudioURLInput.value;
            }

            // Collect secret commands
            for (let i = 0; i < currentSecretCommands.length; i++) {
                const keywordInput = document.getElementById(`cmd-keyword-${i}`);
                const actionSelect = document.getElementById(`cmd-action-${i}`);
                const urlInput = document.getElementById(`cmd-url-${i}`);
                const descInput = document.getElementById(`cmd-desc-${i}`);
                const enabledCheckbox = document.getElementById(`cmd-enabled-${i}`);

                if (keywordInput) {
                    currentSecretCommands[i].keyword = keywordInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                }
                if (actionSelect) {
                    currentSecretCommands[i].action = actionSelect.value;
                }
                if (urlInput) {
                    currentSecretCommands[i].url = urlInput.value;
                }
                if (descInput) {
                    currentSecretCommands[i].description = descInput.value;
                }
                if (enabledCheckbox) {
                    currentSecretCommands[i].enabled = enabledCheckbox.checked;
                }
            }

            // Collect thoughts, responses, actions, and active states (dynamic count)
            const thoughtCount = currentThoughts.length;
            for (let i = 0; i < thoughtCount; i++) {
                const thoughtInput = document.getElementById(`thought-${i}`);
                const responseInput = document.getElementById(`response-${i}`);

                if (thoughtInput) {
                    currentThoughts[i] = thoughtInput.value;
                }
                if (responseInput) {
                    currentResponses[i] = responseInput.value;
                }

                // Collect active state
                const activeCheckbox = document.getElementById(`active-${i}`);
                if (activeCheckbox) {
                    currentActiveStates[i] = activeCheckbox.checked;
                }

                // Collect redirect indices
                const yesRedirectInput = document.getElementById(`yes-redirect-${i}`);
                const noRedirectInput = document.getElementById(`no-redirect-${i}`);
                if (yesRedirectInput) {
                    currentYesRedirectIndices[i] = yesRedirectInput.value;
                }
                if (noRedirectInput) {
                    currentNoRedirectIndices[i] = noRedirectInput.value;
                }

                // Collect choice button texts
                const choiceATextInput = document.getElementById(`choice-a-text-${i}`);
                const choiceBTextInput = document.getElementById(`choice-b-text-${i}`);
                if (choiceATextInput) {
                    currentChoiceATexts[i] = choiceATextInput.value;
                }
                if (choiceBTextInput) {
                    currentChoiceBTexts[i] = choiceBTextInput.value;
                }

                // Collect choice A action configuration
                const choiceAActionSelect = document.getElementById(`choice-a-action-type-${i}`);
                const choiceAEndCheckbox = document.getElementById(`choice-a-end-${i}`);
                if (!currentChoiceAActions[i]) {
                    currentChoiceAActions[i] = { type: 'none', endAction: false };
                }
                if (choiceAActionSelect) {
                    currentChoiceAActions[i].type = choiceAActionSelect.value;
                }
                if (choiceAEndCheckbox) {
                    currentChoiceAActions[i].endAction = choiceAEndCheckbox.checked;
                }

                // Collect choice B action configuration
                const choiceBActionSelect = document.getElementById(`choice-b-action-type-${i}`);
                const choiceBEndCheckbox = document.getElementById(`choice-b-end-${i}`);
                if (!currentChoiceBActions[i]) {
                    currentChoiceBActions[i] = { type: 'none', endAction: false };
                }
                if (choiceBActionSelect) {
                    currentChoiceBActions[i].type = choiceBActionSelect.value;
                }
                if (choiceBEndCheckbox) {
                    currentChoiceBActions[i].endAction = choiceBEndCheckbox.checked;
                }

                // Collect per-card typing speed (10-200ms range)
                const typingSpeedSlider = document.getElementById(`typing-speed-${i}`);
                if (typingSpeedSlider) {
                    currentTypingSpeeds[i] = parseInt(typingSpeedSlider.value, 10) || 100;
                }

                // Collect per-card AI mood
                const moodSelect = document.getElementById(`mood-${i}`);
                if (moodSelect) {
                    currentMoods[i] = moodSelect.value || 'stable';
                }

                // Collect per-card scene audio override
                const sceneAudioInput = document.getElementById(`scene-audio-${i}`);
                const sceneAudioLoopCheckbox = document.getElementById(`scene-audio-loop-${i}`);
                if (!currentSceneAudioOverrides[i]) {
                    currentSceneAudioOverrides[i] = { url: '', loop: true };
                }
                if (sceneAudioInput) {
                    currentSceneAudioOverrides[i].url = sceneAudioInput.value;
                }
                if (sceneAudioLoopCheckbox) {
                    currentSceneAudioOverrides[i].loop = sceneAudioLoopCheckbox.checked;
                }

                // Legacy: Keep old action type for backwards compatibility (default to none)
                if (!currentActions[i]) {
                    currentActions[i] = { type: 'none', url: '', logo: '', linkText: 'Click here' };
                }
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = 'toast visible ' + type;

            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // Push configuration to Firebase (replaced downloadConfig)
        function downloadConfig() {
            // Collect current form data
            collectCurrentFormData();

            const config = {
                heroText: currentHeroText,
                thoughts: [...currentThoughts],
                responses: [...currentResponses],
                actions: currentActions.map(a => ({...a})),
                activeStates: [...currentActiveStates],
                yesRedirectIndices: [...currentYesRedirectIndices],
                noRedirectIndices: [...currentNoRedirectIndices],
                choiceATexts: [...currentChoiceATexts],
                choiceBTexts: [...currentChoiceBTexts],
                choiceAActions: currentChoiceAActions.map(a => ({...a})),
                choiceBActions: currentChoiceBActions.map(a => ({...a})),
                typingSpeeds: [...currentTypingSpeeds],
                moods: [...currentMoods],
                settings: {
                    choiceButtonsEnabled: currentChoiceButtonsEnabled,
                    matrixFadeDuration: currentMatrixFadeDuration,
                    earthquakeDuration: currentEarthquakeDuration,
                    curtainDuration: currentCurtainDuration,
                    earthquakeEnabled: currentEarthquakeEnabled,
                    bootSequenceEnabled: currentBootSequenceEnabled,
                    randomizeEnabled: currentRandomizeEnabled
                },
                secretCommands: currentSecretCommands.map(cmd => ({...cmd})),
                buildersMedia: {...currentBuildersMedia},
                bootScript: currentBootScript,
                backgroundImageUrl: currentBackgroundImageUrl,
                intermissionImageUrl: currentIntermissionImageUrl,
                techDifficultyImageUrl: currentTechDifficultyImageUrl,
                finImageUrl: currentFinImageUrl,
                meltdownMessage: currentMeltdownMessage,
                meltdownAudioURL: currentMeltdownAudioURL,
                mst3kOverlayURL: currentMst3kOverlayURL,
                mst3kGlowIntensity: currentMst3kGlowIntensity,
                theaterFrameURL: currentTheaterFrameURL,
                globalAmbientAudioURL: currentGlobalAmbientAudioURL,
                sceneAudioOverrides: currentSceneAudioOverrides.map(s => ({...s}))
            };

            // Push to Firebase instead of downloading
            set(ref(db, 'siteConfig'), config)
                .then(() => {
                    showToast("Live Update Successful! All sites updated.", "success");
                })
                .catch((error) => {
                    console.error("Firebase Update Failed:", error);
                    showToast("Update failed. Check console.", "error");
                });
        }

        // Reset to defaults - DISABLED (Firebase is sole source of truth)
        function factoryReset() {
            showToast('Reset to Defaults is disabled. Firebase is the sole source of truth.', 'error');
            return;
        }

        // Expose functions to global scope for onclick handlers
        window.handleCommandEnabledChange = handleCommandEnabledChange;
        window.handleCommandActionChange = handleCommandActionChange;
        window.updateCommandKeyword = updateCommandKeyword;
        window.updateCommandUrl = updateCommandUrl;
        window.updateCommandDescription = updateCommandDescription;
        window.addNewSecretCommand = addNewSecretCommand;
        window.deleteSecretCommand = deleteSecretCommand;
        window.addNewThought = addNewThought;
        window.deleteThought = deleteThought;
        window.handleActiveChange = handleActiveChange;
        window.handleActionTypeChange = handleActionTypeChange;
        window.handleChoiceActionChange = handleChoiceActionChange;
        window.updateTypingSpeedDisplay = updateTypingSpeedDisplay;
        window.downloadConfig = downloadConfig;
        window.factoryReset = factoryReset;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for remote config to load before initializing
            await configPromise;
            loadFromConfig();
            renderDashboard();
        });
    </script>
</body>
</html>
