<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - ImagineCraft Studios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1F1F1F;
            --background: #FAFAF7;
            --accent: #5B5FEA;
            --glass: rgba(255, 255, 255, 0.1);
            --charcoal: var(--primary);
            --off-white: var(--background);
            --charcoal-light: #2a2a2a;
            --off-white-dark: #e8e8e5;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--charcoal);
            color: var(--off-white);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--off-white);
            font-size: 0.95rem;
            font-weight: 400;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .nav-links a:hover {
            opacity: 1;
        }

        /* Dashboard Section */
        .dashboard {
            display: block;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
        }

        .dashboard-actions .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #16a34a;
        }

        .btn-danger {
            background-color: var(--error);
            border-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Hero Text Section */
        .hero-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .hero-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .hero-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .hero-section input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .hero-section input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Navigation Links Section */
        .nav-links-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .nav-links-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .nav-links-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .nav-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .nav-links-section .form-group {
            margin-bottom: 0;
        }

        .nav-links-section label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-links-section input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .nav-links-section input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Thought Cards */
        .thoughts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .thought-card {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .thought-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .thought-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .thought-card .card-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .thought-card .card-number {
            background: var(--charcoal);
            color: var(--off-white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .thought-card label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .thought-card input,
        .thought-card textarea {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .thought-card input:focus,
        .thought-card textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .thought-card textarea {
            min-height: 80px;
            resize: vertical;
        }

        .thought-card textarea.thought-textarea {
            min-height: 250px;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
        }

        .thought-card .form-group {
            margin-bottom: 1rem;
        }

        .thought-card .form-group:last-child {
            margin-bottom: 0;
        }

        /* Action Type Dropdown */
        .thought-card select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F1F1F' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .thought-card select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        /* Conditional Action Fields */
        .action-fields {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--background);
            border-radius: 8px;
            border: 1px dashed var(--off-white-dark);
        }

        .action-fields.hidden {
            display: none;
        }

        .action-fields label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .action-fields input,
        .action-fields textarea {
            margin-top: 0.5rem;
        }

        .action-fields textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            min-height: 120px;
            line-height: 1.4;
        }

        /* Final Actions Grid */
        .final-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .final-action-card {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            border-left: 4px solid #dc143c;
        }

        .final-action-card:hover {
            box-shadow: 0 8px 30px rgba(220, 20, 60, 0.12);
            transform: translateY(-2px);
        }

        .final-action-card .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .final-action-card .action-icon {
            font-size: 1.5rem;
        }

        .final-action-card .action-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .final-action-card label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .final-action-card input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .final-action-card input:focus {
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .final-action-card .audio-hint {
            font-size: 0.75rem;
            color: rgba(31, 31, 31, 0.5);
            margin-top: 0.35rem;
        }

        /* URL Input with Browse Button */
        .url-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .url-input-wrapper input[type="url"] {
            flex: 1;
            min-width: 0;
        }

        .browse-assets-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.5rem 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .browse-assets-btn:hover {
            background: #4a4ed8;
            transform: translateY(-1px);
        }

        .browse-assets-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Asset Picker Modal */
        .asset-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .asset-picker-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .asset-picker-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .asset-picker-overlay.visible .asset-picker-modal {
            transform: scale(1);
        }

        .asset-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--off-white-dark);
        }

        .asset-picker-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .asset-picker-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: rgba(31, 31, 31, 0.5);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .asset-picker-close:hover {
            color: var(--primary);
        }

        .asset-picker-search {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--off-white-dark);
        }

        .asset-picker-search input {
            width: 100%;
            padding: 0.75rem;
            font-size: 0.95rem;
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .asset-picker-search input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .asset-picker-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }

        .asset-picker-loading,
        .asset-picker-error,
        .asset-picker-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(31, 31, 31, 0.6);
        }

        .asset-picker-loading::before {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--off-white-dark);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .asset-picker-error {
            color: var(--error);
        }

        .asset-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .asset-item:hover {
            background: var(--background);
        }

        .asset-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background);
            border-radius: 6px;
            font-size: 1rem;
        }

        .asset-icon.audio {
            background: rgba(147, 51, 234, 0.1);
            color: #9333ea;
        }

        .asset-icon.image {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .asset-icon.video {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .asset-icon.other {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .asset-details {
            flex: 1;
            min-width: 0;
        }

        .asset-name {
            font-weight: 500;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-size {
            font-size: 0.8rem;
            color: rgba(31, 31, 31, 0.5);
        }

        .asset-type-filter {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--off-white-dark);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
            border: 1px solid var(--off-white-dark);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--charcoal);
            color: var(--off-white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        /* Typing Speed Section */
        .typing-speed-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .typing-speed-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .typing-speed-section p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1rem;
        }

        .slider-container {
            max-width: 400px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--off-white-dark);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .speed-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(91, 95, 234, 0.2);
        }

        .speed-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: var(--primary);
        }

        .slider-value span {
            font-weight: 600;
            color: var(--accent);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--off-white-dark);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.2);
        }

        .toggle-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--primary);
        }

        /* Active Checkbox for Thought Cards */
        .active-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .active-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .active-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
        }

        .thought-card.inactive {
            opacity: 0.6;
            border-color: var(--off-white-dark);
        }

        .thought-card.inactive .card-number {
            background: var(--off-white-dark);
            color: rgba(31, 31, 31, 0.5);
        }

        /* Questions Header Section with Randomize Toggle */
        .questions-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 12px;
        }

        .randomize-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .randomize-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .randomize-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
        }

        .randomize-hint {
            font-size: 0.8rem;
            color: rgba(31, 31, 31, 0.5);
            font-style: italic;
        }

        /* Mood Selector Styles */
        .mood-selector-container {
            max-width: 500px;
        }

        .mood-select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F1F1F' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .mood-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .mood-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #000000;
            border-radius: 8px;
            font-family: 'VT323', 'Courier New', monospace;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

        .mood-preview-text {
            display: inline-block;
        }

        .mood-preview.stable {
            color: #34ff35;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.6);
        }

        .mood-preview.glitchy {
            color: #34ff35;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.6);
            animation: glitchPreview 0.5s infinite;
        }

        .mood-preview.urgent {
            color: #ff3434;
            text-shadow: 0 0 8px rgba(255, 52, 52, 0.6);
        }

        @keyframes glitchPreview {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); }
            40% { transform: translate(1px, -1px); filter: hue-rotate(180deg); }
            60% { transform: translate(-1px, 0); filter: hue-rotate(270deg); }
            80% { transform: translate(2px, 1px); filter: hue-rotate(360deg); }
            100% { transform: translate(0); filter: hue-rotate(0deg); }
        }

        /* Secret Commands Section */
        .secret-commands-section {
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .secret-commands-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .secret-commands-section > p {
            font-size: 0.9rem;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 1.5rem;
        }

        .secret-commands-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .secret-command-card {
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 12px;
            padding: 1.25rem;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .secret-command-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            border-color: var(--accent);
        }

        .secret-command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .secret-command-keyword {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .keyword-badge {
            background: linear-gradient(135deg, #1F1F1F, #2a2a2a);
            color: #34ff35;
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            letter-spacing: 0.1em;
            text-shadow: 0 0 8px rgba(52, 255, 53, 0.4);
            box-shadow: inset 0 0 10px rgba(52, 255, 53, 0.1);
        }

        .secret-command-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .secret-command-body {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .secret-command-body .form-group {
            margin-bottom: 0;
        }

        .secret-command-body label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .secret-command-body input,
        .secret-command-body select {
            width: 100%;
            padding: 0.6rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.9rem;
            color: var(--primary);
            background: white;
            border: 1px solid var(--off-white-dark);
            border-radius: 6px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .secret-command-body input:focus,
        .secret-command-body select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .secret-command-body .url-field {
            grid-column: span 2;
        }

        @media (max-width: 600px) {
            .secret-command-body .url-field {
                grid-column: span 1;
            }
        }

        .delete-command-btn {
            background: transparent;
            border: 1px solid var(--error);
            color: var(--error);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-command-btn:hover {
            background: var(--error);
            color: white;
        }

        .add-command-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 2px dashed var(--accent);
            color: var(--accent);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-command-btn:hover {
            background: rgba(91, 95, 234, 0.1);
            border-style: solid;
        }

        .add-command-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Builders Media Section Input Styles */
        .typing-speed-section .nav-links-grid input,
        .typing-speed-section .nav-links-grid select {
            width: 100%;
            padding: 0.75rem;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            color: var(--primary);
            background: var(--background);
            border: 1px solid var(--off-white-dark);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .typing-speed-section .nav-links-grid input:focus,
        .typing-speed-section .nav-links-grid select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 95, 234, 0.1);
        }

        .typing-speed-section .nav-links-grid label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(31, 31, 31, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .login-card {
                padding: 2rem;
            }

            .dashboard {
                padding: 1.5rem;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .thoughts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Tab System Styles */
        .admin-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--off-white-dark);
        }

        .admin-tab-btn {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: rgba(31, 31, 31, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: -2px;
        }

        .admin-tab-btn:hover {
            color: var(--primary);
            background: rgba(91, 95, 234, 0.05);
        }

        .admin-tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .admin-tab-btn .tab-icon {
            margin-right: 0.5rem;
        }

        .admin-tab-panel {
            display: none;
        }

        .admin-tab-panel.active {
            display: block;
        }

        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
                border-bottom: none;
                gap: 0.5rem;
            }

            .admin-tab-btn {
                border-bottom: none;
                border-left: 3px solid transparent;
                text-align: left;
                margin-bottom: 0;
            }

            .admin-tab-btn.active {
                border-bottom: none;
                border-left-color: var(--accent);
                background: rgba(91, 95, 234, 0.1);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">ImagineCraft Studios</div>
        <nav>
            <ul class="nav-links">
                <li><a href="main.html">Main Site</a></li>
                <li><a href="index.html">Explore</a></li>
            </ul>
        </nav>
    </header>

    <!-- Dashboard Section -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <h1>Remote Config Generator</h1>
            <div class="dashboard-actions">
                <button class="btn btn-success" onclick="downloadConfig()">Push Live Update</button>
                <button class="btn btn-danger" onclick="factoryReset()" disabled style="opacity: 0.5; cursor: not-allowed;">Reset to Defaults (Disabled)</button>
            </div>
        </div>

        <!-- Instructions Banner -->
        <div style="background: linear-gradient(135deg, #5B5FEA, #4a4ed8); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(91, 95, 234, 0.2);">
            <h3 style="margin: 0 0 0.75rem 0; font-size: 1.1rem; font-weight: 600;">How to Update Your Site</h3>
            <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.95rem; line-height: 1.8;">
                <li>Edit your content below (changes are temporary - not saved automatically)</li>
                <li>Click "Push Live Update" to instantly publish to all browsers via Firebase</li>
                <li>All connected browsers will update in real-time - no refresh needed!</li>
            </ol>
            <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">Note: This panel doesn't save changes permanently until you push them live. All your edits exist only in this session until you click "Push Live Update".</p>
        </div>

        <!-- Narrative Persistence Testing Section -->
        <div style="background: linear-gradient(135deg, #1F1F1F, #333); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
            <h3 style="margin: 0 0 0.75rem 0; font-size: 1.1rem; font-weight: 600;">ðŸŽ­ Narrative Persistence (Testing Tools)</h3>
            <p style="margin: 0 0 1rem 0; font-size: 0.9rem; opacity: 0.85;">
                The Ghost remembers users who have died 3+ times. Use these tools to test the system.
            </p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <button class="btn" onclick="resetNarrativeMemory()" style="background: #ef4444; border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Reset Memory
                </button>
                <button class="btn" onclick="simulateEndings()" style="background: #5B5FEA; border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Simulate 3 Deaths
                </button>
                <span id="endingCount" style="font-size: 0.85rem; opacity: 0.8; margin-left: 0.5rem;">
                    Current endings: <strong id="endingCountNumber">0</strong>
                </span>
                <span style="font-size: 0.85rem; opacity: 0.8; margin-left: 0.5rem; padding-left: 0.5rem; border-left: 1px solid rgba(255,255,255,0.3);">
                    Current Story Part: <strong id="storyPartNumber">1</strong>
                </span>
            </div>
            <p style="margin: 1rem 0 0 0; font-size: 0.8rem; opacity: 0.7;">
                <strong>Reset Memory:</strong> Clears all saved endings and resets story part counter to 1. <strong>Simulate 3 Deaths:</strong> Adds sample endings to trigger Ghost Awareness mode.
            </p>
        </div>

        <!-- Admin Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab-btn active" data-tab="config" onclick="switchAdminTab('config')">
                <span class="tab-icon">&#9881;</span>Config
            </button>
            <button class="admin-tab-btn" data-tab="story" onclick="switchAdminTab('story')">
                <span class="tab-icon">&#9997;</span>Story
            </button>
            <button class="admin-tab-btn" data-tab="finalActions" onclick="switchAdminTab('finalActions')">
                <span class="tab-icon">&#9760;</span>Final Actions
            </button>
        </div>

        <!-- Tab Panel: Config -->
        <div class="admin-tab-panel active" id="configTabPanel">

        <!-- Hero Text Section -->
        <div class="hero-section">
            <h2>Hero Heading</h2>
            <p>This is the main static heading displayed at the top. It does not cycle like the thoughts.</p>
            <input type="text" id="heroText" placeholder="Enter hero heading..." value="WHY ARE YOU HERE?">
        </div>

        <!-- Site Configuration Section -->
        <div class="hero-section">
            <h2>Site Configuration</h2>
            <p>Configure global site settings and visual elements.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Studio Production Name</label>
                    <input type="text" id="studioProductionName" placeholder="The Ghost" value="The Ghost">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        The studio name displayed in the opening credits sequence (e.g., "A Production by The Ghost")
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>MST3K Overlay URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="mst3kOverlayURL" placeholder="https://example.com/mst3k-silhouettes.png">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('mst3kOverlayURL')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Transparent PNG overlay for the MST3K theater silhouettes (positioned at bottom of screen)
                    </p>
                </div>
                <div class="form-group">
                    <label>MST3K Screen Glow Intensity</label>
                    <input type="number" id="mst3kGlowIntensity" placeholder="0.6" min="0" max="1" step="0.1">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Controls the green glow transparency (0 = no glow, 1 = maximum glow)
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Theater Frame URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="theaterFrameURL" placeholder="https://example.com/curtainbkg.png">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('theaterFrameURL')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Permanent theater curtain frame overlay (positioned as full-screen background behind silhouettes)
                    </p>
                </div>
            </div>
        </div>

        <!-- Global Ambient Audio Section -->
        <div class="typing-speed-section">
            <h2>Global Ambient Audio</h2>
            <p>Set a background audio track that loops continuously after the user's first interaction. Scene-specific overrides can replace this audio temporarily.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Global Ambient Audio URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="globalAmbientAudioURL" placeholder="https://example.com/ambient-loop.mp3">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('globalAmbientAudioURL')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Audio will start on loop after the user clicks anywhere on the site for the first time.
                    </p>
                </div>
            </div>
        </div>

        <!-- Enable Ghost Memory Section -->
        <div class="typing-speed-section">
            <h2>Enable Ghost Memory</h2>
            <p>When enabled, returning users who have reached 3+ unique endings will see the "Ghost Awareness" welcome sequence that remembers their previous deaths. When disabled, all users see the normal entry page.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="ghostMemoryToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="ghostMemoryToggleLabel">Disabled</span>
            </div>
        </div>

        <!-- Enable Choice Buttons Section -->
        <div class="typing-speed-section">
            <h2>Enable Choice Buttons</h2>
            <p>When enabled, Yes/No buttons appear after each thought finishes typing. "Yes" shows the response, "No" skips to the next thought. When disabled, thoughts auto-cycle after a linger period.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="choiceButtonsToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="choiceButtonsToggleLabel">Disabled</span>
            </div>
        </div>

        <!-- Matrix Fade Duration Section -->
        <div class="typing-speed-section">
            <h2>Matrix Fade Duration</h2>
            <p>Adjust how long the Matrix rain animation takes to fade out. This controls the cinematic disappearance effect.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (0.5s)</span>
                    <span>Slow (5s)</span>
                </div>
                <input type="range" id="matrixFadeSlider" min="0.5" max="5" step="0.1" value="1.5" class="speed-slider">
                <div class="slider-value">
                    <span id="matrixFadeValue">1.5</span>s fade duration
                </div>
            </div>
        </div>

        <!-- Earthquake Duration Section -->
        <div class="typing-speed-section">
            <h2>Earthquake Duration</h2>
            <p>Adjust how many seconds the screen shakes before the terminal splits and reveals the main site. Longer durations create more dramatic tension.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (0.5s)</span>
                    <span>Long (5s)</span>
                </div>
                <input type="range" id="earthquakeDurationSlider" min="0.5" max="5" step="0.1" value="1.5" class="speed-slider">
                <div class="slider-value">
                    <span id="earthquakeDurationValue">1.5</span>s shake duration
                </div>
            </div>
        </div>

        <!-- Curtain Rise Duration Section -->
        <div class="typing-speed-section">
            <h2>Curtain Rise Duration</h2>
            <p>Adjust how long the theater curtain takes to split and reveal the terminal. The typing animation will begin only after the curtain has fully risen. Longer durations create more anticipation.</p>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Quick (1s)</span>
                    <span>Dramatic (10s)</span>
                </div>
                <input type="range" id="curtainDurationSlider" min="1" max="10" step="0.5" value="4" class="speed-slider">
                <div class="slider-value">
                    <span id="curtainDurationValue">4</span>s curtain rise
                </div>
            </div>
        </div>

        <!-- Earthquake Transition Section -->
        <div class="typing-speed-section">
            <h2>Earthquake Transition</h2>
            <p>When enabled, clicking "Enter Main Site" will trigger a dramatic earthquake shake and screen crack effect before navigating to the main site.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="earthquakeToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="earthquakeToggleLabel">Enabled</span>
            </div>
        </div>

        <!-- Boot Sequence Section -->
        <div class="typing-speed-section">
            <h2>Enable Boot Sequence</h2>
            <p>When enabled, the site will display a "Power Up" boot sequence with system diagnostics and a progress bar on first load. The sequence only plays once per browser session.</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="bootSequenceToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="bootSequenceToggleLabel">Enabled</span>
            </div>
        </div>

        <!-- Boot Sequence Script Section -->
        <div class="typing-speed-section">
            <h2>Boot Sequence Script</h2>
            <p>Customize the diagnostic lines shown during the boot sequence. Enter one line per row. Each line will be typed out with the green terminal style and fast typing speed.</p>
            <textarea id="bootScriptTextarea"
                      style="width: 100%; min-height: 150px; padding: 0.75rem; font-family: 'VT323', 'Courier New', monospace; font-size: 1rem; color: var(--primary); background: var(--background); border: 1px solid var(--off-white-dark); border-radius: 8px; resize: vertical; line-height: 1.5;"
                      placeholder="CORE_INIT: OK&#10;MEM_LOAD: 1024KB&#10;DRV_MOUNT: /assets&#10;NET_STACK: READY&#10;SYS_CHECK: COMPLETE">CORE_INIT: OK
MEM_LOAD: 1024KB
DRV_MOUNT: /assets
NET_STACK: READY
SYS_CHECK: COMPLETE</textarea>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Keep lines short and tech-y for the best effect. Use colons and status words like OK, READY, COMPLETE, etc.
            </p>
        </div>

        <!-- Background Image Section -->
        <div class="typing-speed-section">
            <h2>Background Image URL</h2>
            <p>Set the background image shown behind the curtains during the opening sequence. This image will be revealed when the boot sequence completes and the black overlay fades out.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Background Image URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="backgroundImageUrl" placeholder="https://example.com/background.jpg">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('backgroundImageUrl')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: For best results, use a high-resolution image. The image will be positioned behind the terminal text/buttons but in front of the black background. If the image takes more than 3 seconds to load, the site will continue anyway.
            </p>
        </div>

        <!-- Builders Media Section (for TRANSPARENT command) -->
        <div class="typing-speed-section">
            <h2>Builders Image/Video URL</h2>
            <p>Set the image or video URL shown behind the terminal when the TRANSPARENT command is triggered. This creates the illusion of builders constructing the site behind the screen.</p>
            <div class="nav-links-grid">
                <div class="form-group">
                    <label>Media Type</label>
                    <select id="buildersMediaType" class="mood-select" style="max-width: 200px;">
                        <option value="image">Image</option>
                        <option value="video">Video (MP4)</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Media URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="buildersMediaUrl" placeholder="https://example.com/construction-crew.jpg (or .mp4)">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('buildersMediaUrl')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: For best results, use an image or video of a construction crew with hammers and tools. If left blank, a placeholder animation will be shown.
            </p>
        </div>

        <!-- Cinematic States Section -->
        <div class="typing-speed-section">
            <h2>Cinematic State Overlays</h2>
            <p>Configure the images displayed during automated cinematic states. These overlays are triggered automatically based on user interaction patterns.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Intermission Image URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="intermissionImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Intermission">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('intermissionImageUrl')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered after 120 seconds of user inactivity
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Technical Difficulties Image URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="techDifficultyImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Technical+Difficulties">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('techDifficultyImageUrl')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered after 3 consecutive terminal input errors
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Fin (The End) Image URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="finImageUrl" placeholder="https://via.placeholder.com/1920x1080?text=Fin">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('finImageUrl')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Triggered by the "Trigger Fin" action type in cycling thoughts
                    </p>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Use placeholder URLs until your final cinematic images are ready. Once you update these URLs, the site will automatically pull the new images.
            </p>
        </div>

        <!-- Meltdown Configuration Section -->
        <div class="typing-speed-section">
            <h2>Meltdown Configuration</h2>
            <p>Configure hidden meltdown triggers using [] brackets in Cycling Thoughts. When a user types a bracketed keyword, it triggers a critical system meltdown sequence.</p>
            <div class="nav-links-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Meltdown Message</label>
                    <input type="text" id="meltdownMessage" placeholder="CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN">
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        The high-alert red text that rapidly types during a meltdown sequence
                    </p>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Meltdown Audio URL</label>
                    <div class="url-input-wrapper">
                        <input type="url" id="meltdownAudioURL" placeholder="https://example.com/alarm.mp3">
                        <button type="button" class="browse-assets-btn" onclick="openAssetPicker('meltdownAudioURL')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Browse
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                        Audio/music to play during the meltdown sequence (10 seconds)
                    </p>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.5rem;">
                Tip: Use [] brackets in Cycling Thoughts to define hidden meltdown triggers. Example: "What is [DESTROY]?" will trigger meltdown when user types "DESTROY".
            </p>
        </div>

        <!-- Managed Secret Commands Section -->
        <div class="secret-commands-section">
            <h2>Managed Secret Commands</h2>
            <p>Configure hidden keywords that trigger special actions when typed anywhere on the terminal. Users can type these keywords to activate hidden features.</p>

            <div class="secret-commands-list" id="secretCommandsList">
                <!-- Command cards will be generated by JavaScript -->
            </div>

            <button type="button" class="add-command-btn" onclick="addNewSecretCommand()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Command
            </button>
        </div>

        </div><!-- End Config Tab Panel -->

        <!-- Tab Panel: Story -->
        <div class="admin-tab-panel" id="storyTabPanel">

        <!-- Questions Section with Randomize Toggle -->
        <div class="questions-header-section">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0; color: var(--primary);">Cycling Thoughts & Responses</h2>
            <div class="randomize-toggle-container">
                <input type="checkbox" id="randomizeToggle" class="randomize-checkbox">
                <label for="randomizeToggle" class="randomize-label">Randomize Active Questions</label>
                <span class="randomize-hint">(When enabled, shows 3 random active questions instead of all)</span>
            </div>
        </div>
        <div class="thoughts-grid" id="thoughtsGrid">
            <!-- Cards will be generated by JavaScript -->
        </div>

        <button type="button" class="add-command-btn" onclick="addNewThought()" style="margin-top: 1.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add New Thought
        </button>

        </div><!-- End Story Tab Panel -->

        <!-- Tab Panel: Final Actions -->
        <div class="admin-tab-panel" id="finalActionsTabPanel">

        <div class="hero-section">
            <h2>Final Actions Audio Configuration</h2>
            <p>Configure ending sounds for each final action type. These sounds play immediately when the Death Bridge button is clicked.</p>
        </div>

        <div class="final-actions-grid" id="finalActionsGrid">
            <!-- Cards will be generated by JavaScript -->
        </div>

        </div><!-- End Final Actions Tab Panel -->

    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Changes saved successfully!</span>
    </div>

    <!-- Asset Picker Modal -->
    <div class="asset-picker-overlay" id="assetPickerOverlay">
        <div class="asset-picker-modal">
            <div class="asset-picker-header">
                <h3>Browse Assets</h3>
                <button type="button" class="asset-picker-close" onclick="closeAssetPicker()">&times;</button>
            </div>
            <div class="asset-type-filter" id="assetTypeFilter">
                <button type="button" class="filter-btn active" data-filter="all">All</button>
                <button type="button" class="filter-btn" data-filter="audio">Audio</button>
                <button type="button" class="filter-btn" data-filter="image">Images</button>
                <button type="button" class="filter-btn" data-filter="video">Video</button>
            </div>
            <div class="asset-picker-search">
                <input type="text" id="assetSearchInput" placeholder="Search files..." oninput="filterAssetList()">
            </div>
            <div class="asset-picker-content" id="assetPickerContent">
                <div class="asset-picker-loading">Loading assets...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // ========================================
        // Firebase Configuration
        // ========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Initialize Firebase with your project credentials
        const firebaseConfig = {
            apiKey: "AIzaSyC9Ga6OROaym45ezFh_vJ2WFMVUACkMGXY",
            authDomain: "imaginecraft-live.firebaseapp.com",
            databaseURL: "https://imaginecraft-live-default-rtdb.firebaseio.com",
            projectId: "imaginecraft-live",
            storageBucket: "imaginecraft-live.firebasestorage.app",
            messagingSenderId: "962150460666",
            appId: "1:962150460666:web:382bff8cdb23c191c16d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Remote configuration (loaded from config.json)
        let remoteConfig = null;

        // Hard-coded defaults removed - Firebase is the sole source of truth
        const fallbackThoughts = [];

        const fallbackResponses = [];

        const fallbackHeroText = '';

        // Helper functions to get data from Firebase only (no fallbacks)
        function getDefaultThoughts() {
            if (remoteConfig && remoteConfig.thoughts) {
                return [...remoteConfig.thoughts];
            }
            // If no Firebase data, return a single empty thought to show one empty field
            return [''];
        }
        function getDefaultResponses() {
            if (remoteConfig && remoteConfig.responses) {
                return [...remoteConfig.responses];
            }
            // If no Firebase data, return a single empty response
            return [''];
        }
        function getDefaultHeroText() {
            return remoteConfig && remoteConfig.heroText ? remoteConfig.heroText : '';
        }
        function getDefaultActions() {
            if (remoteConfig && remoteConfig.actions) {
                return remoteConfig.actions.map(a => ({...a}));
            }
            // If no Firebase data, return a single empty action
            return [{ type: 'none', url: '', logo: '', linkText: 'Click here' }];
        }
        function getDefaultActiveStates() {
            if (remoteConfig && remoteConfig.activeStates) {
                return [...remoteConfig.activeStates];
            }
            // If no Firebase data, return a single active state
            return [true];
        }
        function getDefaultYesRedirectIndices() {
            if (remoteConfig && remoteConfig.yesRedirectIndices) {
                return [...remoteConfig.yesRedirectIndices];
            }
            // If no Firebase data, return a single empty redirect
            return [''];
        }
        function getDefaultNoRedirectIndices() {
            if (remoteConfig && remoteConfig.noRedirectIndices) {
                return [...remoteConfig.noRedirectIndices];
            }
            // If no Firebase data, return a single empty redirect
            return [''];
        }
        function getDefaultChoiceATexts() {
            if (remoteConfig && remoteConfig.choiceATexts) {
                return [...remoteConfig.choiceATexts];
            }
            // If no Firebase data, return a single empty text (defaults to "Yes")
            return [''];
        }
        function getDefaultChoiceBTexts() {
            if (remoteConfig && remoteConfig.choiceBTexts) {
                return [...remoteConfig.choiceBTexts];
            }
            // If no Firebase data, return a single empty text (defaults to "No")
            return [''];
        }
        function getDefaultChoiceAActions() {
            if (remoteConfig && remoteConfig.choiceAActions) {
                return remoteConfig.choiceAActions.map(a => ({...a}));
            }
            // If no Firebase data, return a single default choice action
            return [{ type: 'none', endAction: false }];
        }
        function getDefaultChoiceBActions() {
            if (remoteConfig && remoteConfig.choiceBActions) {
                return remoteConfig.choiceBActions.map(a => ({...a}));
            }
            // If no Firebase data, return a single default choice action
            return [{ type: 'none', endAction: false }];
        }
        function getDefaultTypingSpeeds() {
            if (remoteConfig && remoteConfig.typingSpeeds) {
                return [...remoteConfig.typingSpeeds];
            }
            // If no Firebase data, return a single default speed (100ms - middle of 10-200 range)
            return [100];
        }
        function getDefaultMoods() {
            if (remoteConfig && remoteConfig.moods) {
                return [...remoteConfig.moods];
            }
            // If no Firebase data, return a single default mood
            return ['stable'];
        }
        function getDefaultSettings() {
            if (remoteConfig && remoteConfig.settings) {
                return remoteConfig.settings;
            }
            // Default settings if no Firebase data (per-card typingSpeed and mood are now separate arrays)
            return {
                choiceButtonsEnabled: false,
                matrixFadeDuration: 1.5,
                earthquakeDuration: 1.5,
                curtainDuration: 4,
                earthquakeEnabled: true,
                bootSequenceEnabled: true,
                randomizeEnabled: false
            };
        }
        function getDefaultSecretCommands() {
            if (remoteConfig && remoteConfig.secretCommands) {
                return remoteConfig.secretCommands.map(cmd => ({...cmd}));
            }
            // If no Firebase data, return empty array (user can add commands)
            return [];
        }
        function getDefaultBuildersMedia() {
            return remoteConfig && remoteConfig.buildersMedia ? {...remoteConfig.buildersMedia} : { type: 'image', url: '' };
        }
        function getDefaultBootScript() {
            return remoteConfig && remoteConfig.bootScript ? remoteConfig.bootScript : 'CORE_INIT: OK\nMEM_LOAD: 1024KB\nDRV_MOUNT: /assets\nNET_STACK: READY\nSYS_CHECK: COMPLETE';
        }
        function getDefaultBackgroundImageUrl() {
            return remoteConfig && remoteConfig.backgroundImageUrl ? remoteConfig.backgroundImageUrl : '';
        }
        function getDefaultIntermissionImageUrl() {
            return remoteConfig && remoteConfig.intermissionImageUrl ? remoteConfig.intermissionImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }
        function getDefaultTechDifficultyImageUrl() {
            return remoteConfig && remoteConfig.techDifficultyImageUrl ? remoteConfig.techDifficultyImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }
        function getDefaultFinImageUrl() {
            return remoteConfig && remoteConfig.finImageUrl ? remoteConfig.finImageUrl : 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        }

        function getDefaultMeltdownMessage() {
            return remoteConfig && remoteConfig.meltdownMessage ? remoteConfig.meltdownMessage : 'CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN';
        }

        function getDefaultMeltdownAudioURL() {
            return remoteConfig && remoteConfig.meltdownAudioURL ? remoteConfig.meltdownAudioURL : '';
        }

        function getDefaultMst3kOverlayURL() {
            return remoteConfig && remoteConfig.mst3kOverlayURL ? remoteConfig.mst3kOverlayURL : '';
        }

        function getDefaultMst3kGlowIntensity() {
            return remoteConfig && remoteConfig.mst3kGlowIntensity !== undefined ? remoteConfig.mst3kGlowIntensity : 0.6;
        }

        function getDefaultTheaterFrameURL() {
            return remoteConfig && remoteConfig.theaterFrameURL ? remoteConfig.theaterFrameURL : '';
        }

        function getDefaultGlobalAmbientAudioURL() {
            return remoteConfig && remoteConfig.globalAmbientAudioURL ? remoteConfig.globalAmbientAudioURL : '';
        }

        function getDefaultAutoplayAfterIntro() {
            return remoteConfig && remoteConfig.autoplayAfterIntro ? remoteConfig.autoplayAfterIntro : false;
        }

        function getDefaultSceneAudioOverrides() {
            if (remoteConfig && remoteConfig.sceneAudioOverrides) {
                return remoteConfig.sceneAudioOverrides.map(s => ({...s}));
            }
            // If no Firebase data, return empty array
            return [];
        }

        function getDefaultStudioProductionName() {
            return remoteConfig && remoteConfig.studioProductionName ? remoteConfig.studioProductionName : 'The Ghost';
        }

        function getDefaultFinalActionSounds() {
            return remoteConfig && remoteConfig.finalActionSounds ? remoteConfig.finalActionSounds : {};
        }

        // Final action types with icons for the Final Actions tab
        const FINAL_ACTION_CONFIG = [
            { type: 'system-meltdown', label: 'System Meltdown', icon: 'ðŸ’¥' },
            { type: 'chrono-static', label: 'Chrono-Static', icon: 'â±ï¸' },
            { type: 'supernova-flash', label: 'Supernova Flash', icon: 'â˜€ï¸' },
            { type: 'spaghettify', label: 'Spaghettify (Black Hole)', icon: 'ðŸ•³ï¸' },
            { type: 'hull-breach', label: 'Hull Breach', icon: 'ðŸš€' },
            { type: 'oxygen-depletion', label: 'Oxygen Depletion', icon: 'ðŸ’¨' },
            { type: 'recursive-reality', label: 'Recursive Reality', icon: 'ðŸ”„' },
            { type: 'quantum-leak', label: 'Quantum Leak', icon: 'ðŸŒˆ' },
            { type: 'prism-fracture', label: 'Prism Fracture', icon: 'ðŸ”®' },
            { type: 'event-horizon', label: 'Event Horizon', icon: 'âš«' },
            { type: 'hypnotic-spiral', label: 'Hypnotic Spiral', icon: 'ðŸŒ€' },
            { type: 'trigger-fin', label: 'Trigger Fin (The End)', icon: 'ðŸŽ¬' }
        ];

        // Fetch remote configuration from Firebase
        async function fetchRemoteConfig() {
            return new Promise((resolve) => {
                const configRef = ref(db, 'siteConfig');

                onValue(configRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        remoteConfig = data;
                        console.log('Firebase config loaded successfully');
                    } else {
                        console.warn('No config data found in Firebase');
                        remoteConfig = null;
                    }
                    resolve();
                }, (error) => {
                    console.error('Failed to load Firebase config:', error);
                    remoteConfig = null;
                    resolve();
                }, { onlyOnce: true });
            });
        }

        // App version - must match index.html. Increment to force localStorage data refresh
        const APP_VERSION = '1.0.6';
        const DATA_VERSION_KEY = 'imaginecraft_app_version';

        // Check and handle data version mismatch
        function checkDataVersion() {
            try {
                const storedVersion = localStorage.getItem(DATA_VERSION_KEY);
                if (storedVersion !== APP_VERSION) {
                    console.log('App version mismatch. Stored:', storedVersion, 'Current:', APP_VERSION);
                    console.log('Clearing cached data to load fresh defaults...');
                    // Clear all imaginecraft data keys
                    const keysToRemove = [
                        'imaginecraft_thoughts',
                        'imaginecraft_responses',
                        'imaginecraft_hero_text',
                        'imaginecraft_actions',
                        'imaginecraft_active_states',
                        'imaginecraft_randomize_enabled',
                        'imaginecraft_typing_speed',
                        'imaginecraft_choice_buttons_enabled',
                        'imaginecraft_matrix_fade_duration',
                        'imaginecraft_earthquake_duration',
                        'imaginecraft_earthquake_enabled',
                        'imaginecraft_boot_sequence_enabled',
                        'imaginecraft_system_mood',
                        'imaginecraft_secret_commands',
                        'imaginecraft_builders_media'
                    ];
                    keysToRemove.forEach(function(key) {
                        localStorage.removeItem(key);
                    });
                    // Set new version
                    localStorage.setItem(DATA_VERSION_KEY, APP_VERSION);
                    return true; // Data was cleared
                }
                return false; // Version matched, no clear needed
            } catch (e) {
                console.warn('Failed to check data version:', e);
                return false;
            }
        }

        // Initialize the app after fetching remote config
        async function initializeWithRemoteConfig() {
            await fetchRemoteConfig();
            checkDataVersion();
        }

        // Start fetching config immediately
        const configPromise = initializeWithRemoteConfig();

        // Action types
        const ACTION_TYPES = [
            { value: 'none', label: 'None' },
            { value: 'video', label: 'Video' },
            { value: 'image', label: 'Static Image' },
            { value: 'logo', label: 'Logo' },
            { value: 'matrix', label: 'The Matrix' },
            { value: 'audio', label: 'Audio Clip' },
            { value: 'capture-name', label: 'Capture Name' },
            { value: 'trigger-fin', label: 'Trigger Fin (The End)' },
            { value: 'system-meltdown', label: 'System Meltdown' },
            { value: 'prism-fracture', label: 'Prism Fracture' },
            { value: 'chrono-static', label: 'Chrono-Static' },
            { value: 'event-horizon', label: 'Event Horizon' },
            { value: 'hypnotic-spiral', label: 'Hypnotic Spiral (Twilight Zone)' }
        ];

        // Secret command action types
        const SECRET_ACTION_TYPES = [
            { value: 'earthquake', label: 'Trigger Earthquake & Split' },
            { value: 'matrix', label: 'Toggle Matrix Animation' },
            { value: 'warp', label: 'Star Wars Hyperspace Jump' },
            { value: 'transparent', label: 'Transparent (Reveal Builders)' },
            { value: 'redirect', label: 'Redirect to URL' }
        ];

        // CYOA choice-specific action types (for End Action buttons)
        const CHOICE_ACTION_TYPES = [
            { value: 'none', label: 'None (Continue Story)' },
            { value: 'trigger-fin', label: 'Trigger Fin (The End)' },
            { value: 'system-meltdown', label: 'System Meltdown' },
            { value: 'matrix', label: 'The Matrix' },
            { value: 'supernova-flash', label: 'Supernova Flash' },
            { value: 'spaghettify', label: 'Spaghettify (Black Hole)' },
            { value: 'hull-breach', label: 'Hull Breach' },
            { value: 'oxygen-depletion', label: 'Oxygen Depletion' },
            { value: 'recursive-reality', label: 'Recursive Reality (Infinity Mirror)' },
            { value: 'quantum-leak', label: 'Quantum Leak (Rainbow Liquid)' },
            { value: 'prism-fracture', label: 'Prism Fracture' },
            { value: 'chrono-static', label: 'Chrono-Static' },
            { value: 'event-horizon', label: 'Event Horizon' },
            { value: 'hypnotic-spiral', label: 'Hypnotic Spiral (Twilight Zone)' }
        ];

        // Current data (will be initialized after config loads)
        let currentThoughts = [];
        let currentResponses = [];
        let currentHeroText = '';
        let currentActions = [];
        let currentActiveStates = [];
        let currentYesRedirectIndices = [];
        let currentNoRedirectIndices = [];
        let currentChoiceATexts = [];
        let currentChoiceBTexts = [];
        let currentChoiceAActions = [];
        let currentChoiceBActions = [];
        let currentTypingSpeeds = [];  // Per-card typing speeds (10-200ms)
        let currentMoods = [];          // Per-card AI moods (stable, glitchy, urgent)
        let currentRandomizeEnabled = false;
        let currentGhostMemoryEnabled = false;
        let currentChoiceButtonsEnabled = false;
        let currentMatrixFadeDuration = 1.5;
        let currentEarthquakeDuration = 1.5;
        let currentCurtainDuration = 4;
        let currentEarthquakeEnabled = true;
        let currentBootSequenceEnabled = true;
        let currentSecretCommands = [];
        let currentBuildersMedia = { type: 'image', url: '' };
        let currentBootScript = 'CORE_INIT: OK\nMEM_LOAD: 1024KB\nDRV_MOUNT: /assets\nNET_STACK: READY\nSYS_CHECK: COMPLETE';
        let currentBackgroundImageUrl = '';
        let currentIntermissionImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentTechDifficultyImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentFinImageUrl = 'https://via.placeholder.com/1920x1080?text=IMAGE+PENDING';
        let currentMeltdownMessage = 'CRITICAL SYSTEM FAILURE - INITIATING EMERGENCY SHUTDOWN';
        let currentMeltdownAudioURL = '';
        let currentMst3kOverlayURL = '';
        let currentMst3kGlowIntensity = 0.6;
        let currentTheaterFrameURL = '';
        let currentGlobalAmbientAudioURL = '';
        let currentAutoplayAfterIntro = false;  // Auto-transition from intro to ambient audio
        let currentSceneAudioOverrides = [];  // Per-card audio overrides: { url: '', loop: true }
        let currentStudioProductionName = 'The Ghost';
        let currentFinalActionSounds = {};  // Map of action type to ending sound URL

        // Initialize default actions
        function initDefaultActions() {
            return getDefaultActions();
        }

        // Load data from config.json (no localStorage)
        function loadFromConfig() {
            const defaults = getDefaultSettings();
            try {
                currentThoughts = getDefaultThoughts();
                currentResponses = getDefaultResponses();
                currentHeroText = getDefaultHeroText();
                currentActions = initDefaultActions();
                currentActiveStates = getDefaultActiveStates();
                currentYesRedirectIndices = getDefaultYesRedirectIndices();
                currentNoRedirectIndices = getDefaultNoRedirectIndices();
                currentChoiceATexts = getDefaultChoiceATexts();
                currentChoiceBTexts = getDefaultChoiceBTexts();
                currentChoiceAActions = getDefaultChoiceAActions();
                currentChoiceBActions = getDefaultChoiceBActions();
                currentTypingSpeeds = getDefaultTypingSpeeds();
                currentMoods = getDefaultMoods();
                currentRandomizeEnabled = defaults.randomizeEnabled || false;
                currentGhostMemoryEnabled = defaults.ghostMemoryEnabled || false;
                currentChoiceButtonsEnabled = defaults.choiceButtonsEnabled || false;
                currentMatrixFadeDuration = defaults.matrixFadeDuration || 1.5;
                currentEarthquakeDuration = defaults.earthquakeDuration || 1.5;
                currentCurtainDuration = defaults.curtainDuration || 4;
                currentEarthquakeEnabled = defaults.earthquakeEnabled !== undefined ? defaults.earthquakeEnabled : true;
                currentBootSequenceEnabled = defaults.bootSequenceEnabled !== undefined ? defaults.bootSequenceEnabled : true;
                currentSecretCommands = getDefaultSecretCommands();
                currentBuildersMedia = getDefaultBuildersMedia();
                currentBootScript = getDefaultBootScript();
                currentBackgroundImageUrl = getDefaultBackgroundImageUrl();
                currentIntermissionImageUrl = getDefaultIntermissionImageUrl();
                currentTechDifficultyImageUrl = getDefaultTechDifficultyImageUrl();
                currentFinImageUrl = getDefaultFinImageUrl();
                currentMeltdownMessage = getDefaultMeltdownMessage();
                currentMeltdownAudioURL = getDefaultMeltdownAudioURL();
                currentMst3kOverlayURL = getDefaultMst3kOverlayURL();
                currentMst3kGlowIntensity = getDefaultMst3kGlowIntensity();
                currentTheaterFrameURL = getDefaultTheaterFrameURL();
                currentGlobalAmbientAudioURL = getDefaultGlobalAmbientAudioURL();
                currentAutoplayAfterIntro = getDefaultAutoplayAfterIntro();
                currentSceneAudioOverrides = getDefaultSceneAudioOverrides();
                currentStudioProductionName = getDefaultStudioProductionName();
                currentFinalActionSounds = getDefaultFinalActionSounds();

                // Ensure all actions exist (based on thought count)
                const thoughtCount = currentThoughts.length;
                while (currentActions.length < thoughtCount) {
                    currentActions.push({ type: 'none', url: '', logo: '', linkText: 'Click here' });
                }
                // Ensure all active states exist (default to true)
                while (currentActiveStates.length < thoughtCount) {
                    currentActiveStates.push(true);
                }
                // Ensure all redirect indices exist (default to empty string)
                while (currentYesRedirectIndices.length < thoughtCount) {
                    currentYesRedirectIndices.push('');
                }
                while (currentNoRedirectIndices.length < thoughtCount) {
                    currentNoRedirectIndices.push('');
                }
                // Ensure all choice texts exist (default to empty string for Yes/No defaults)
                while (currentChoiceATexts.length < thoughtCount) {
                    currentChoiceATexts.push('');
                }
                while (currentChoiceBTexts.length < thoughtCount) {
                    currentChoiceBTexts.push('');
                }
                // Ensure all choice actions exist (default to none, no end action)
                while (currentChoiceAActions.length < thoughtCount) {
                    currentChoiceAActions.push({ type: 'none', endAction: false });
                }
                while (currentChoiceBActions.length < thoughtCount) {
                    currentChoiceBActions.push({ type: 'none', endAction: false });
                }
                // Ensure all per-card typing speeds exist (default to 100ms - middle of 10-200 range)
                while (currentTypingSpeeds.length < thoughtCount) {
                    currentTypingSpeeds.push(100);
                }
                // Ensure all per-card moods exist (default to 'stable')
                while (currentMoods.length < thoughtCount) {
                    currentMoods.push('stable');
                }
                // Ensure all per-card scene audio overrides exist (default to empty)
                while (currentSceneAudioOverrides.length < thoughtCount) {
                    currentSceneAudioOverrides.push({ url: '', loop: true });
                }
            } catch (e) {
                console.warn('Failed to load from config:', e);
                currentThoughts = getDefaultThoughts();
                currentResponses = getDefaultResponses();
                currentHeroText = getDefaultHeroText();
                currentActions = initDefaultActions();
                currentActiveStates = getDefaultActiveStates();
                currentYesRedirectIndices = getDefaultYesRedirectIndices();
                currentNoRedirectIndices = getDefaultNoRedirectIndices();
                currentChoiceATexts = getDefaultChoiceATexts();
                currentChoiceBTexts = getDefaultChoiceBTexts();
                currentChoiceAActions = getDefaultChoiceAActions();
                currentChoiceBActions = getDefaultChoiceBActions();
                currentTypingSpeeds = getDefaultTypingSpeeds();
                currentMoods = getDefaultMoods();
                currentRandomizeEnabled = defaults.randomizeEnabled || false;
                currentGhostMemoryEnabled = defaults.ghostMemoryEnabled || false;
                currentChoiceButtonsEnabled = defaults.choiceButtonsEnabled || false;
                currentMatrixFadeDuration = defaults.matrixFadeDuration || 1.5;
                currentEarthquakeDuration = defaults.earthquakeDuration || 1.5;
                currentCurtainDuration = defaults.curtainDuration || 4;
                currentEarthquakeEnabled = defaults.earthquakeEnabled !== undefined ? defaults.earthquakeEnabled : true;
                currentBootSequenceEnabled = defaults.bootSequenceEnabled !== undefined ? defaults.bootSequenceEnabled : true;
                currentSecretCommands = getDefaultSecretCommands();
                currentBuildersMedia = getDefaultBuildersMedia();
                currentBootScript = getDefaultBootScript();
                currentBackgroundImageUrl = getDefaultBackgroundImageUrl();
                currentIntermissionImageUrl = getDefaultIntermissionImageUrl();
                currentTechDifficultyImageUrl = getDefaultTechDifficultyImageUrl();
                currentFinImageUrl = getDefaultFinImageUrl();
                currentMeltdownMessage = getDefaultMeltdownMessage();
                currentMeltdownAudioURL = getDefaultMeltdownAudioURL();
                currentMst3kOverlayURL = getDefaultMst3kOverlayURL();
                currentMst3kGlowIntensity = getDefaultMst3kGlowIntensity();
                currentTheaterFrameURL = getDefaultTheaterFrameURL();
                currentGlobalAmbientAudioURL = getDefaultGlobalAmbientAudioURL();
                currentAutoplayAfterIntro = getDefaultAutoplayAfterIntro();
                currentSceneAudioOverrides = getDefaultSceneAudioOverrides();
                currentStudioProductionName = getDefaultStudioProductionName();
                currentFinalActionSounds = getDefaultFinalActionSounds();
            }
        }

        // Render full dashboard
        function renderDashboard() {
            // Update hero text field
            const heroInput = document.getElementById('heroText');
            if (heroInput) {
                heroInput.value = currentHeroText;
            }

            // Update studio production name field
            const studioNameInput = document.getElementById('studioProductionName');
            if (studioNameInput) {
                studioNameInput.value = currentStudioProductionName;
            }

            // Update ghost memory toggle
            const ghostMemoryToggle = document.getElementById('ghostMemoryToggle');
            const ghostMemoryToggleLabel = document.getElementById('ghostMemoryToggleLabel');
            if (ghostMemoryToggle && ghostMemoryToggleLabel) {
                ghostMemoryToggle.checked = currentGhostMemoryEnabled;
                ghostMemoryToggleLabel.textContent = currentGhostMemoryEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                ghostMemoryToggle.addEventListener('change', function() {
                    ghostMemoryToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update choice buttons toggle
            const choiceButtonsToggle = document.getElementById('choiceButtonsToggle');
            const choiceButtonsToggleLabel = document.getElementById('choiceButtonsToggleLabel');
            if (choiceButtonsToggle && choiceButtonsToggleLabel) {
                choiceButtonsToggle.checked = currentChoiceButtonsEnabled;
                choiceButtonsToggleLabel.textContent = currentChoiceButtonsEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                choiceButtonsToggle.addEventListener('change', function() {
                    choiceButtonsToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update matrix fade duration slider
            const matrixFadeSlider = document.getElementById('matrixFadeSlider');
            const matrixFadeValue = document.getElementById('matrixFadeValue');
            if (matrixFadeSlider && matrixFadeValue) {
                matrixFadeSlider.value = currentMatrixFadeDuration;
                matrixFadeValue.textContent = currentMatrixFadeDuration;

                // Add event listener for real-time value update
                matrixFadeSlider.addEventListener('input', function() {
                    matrixFadeValue.textContent = this.value;
                });
            }

            // Update earthquake duration slider
            const earthquakeDurationSlider = document.getElementById('earthquakeDurationSlider');
            const earthquakeDurationValue = document.getElementById('earthquakeDurationValue');
            if (earthquakeDurationSlider && earthquakeDurationValue) {
                earthquakeDurationSlider.value = currentEarthquakeDuration;
                earthquakeDurationValue.textContent = currentEarthquakeDuration;

                // Add event listener for real-time value update
                earthquakeDurationSlider.addEventListener('input', function() {
                    earthquakeDurationValue.textContent = this.value;
                });
            }

            // Update curtain duration slider
            const curtainDurationSlider = document.getElementById('curtainDurationSlider');
            const curtainDurationValue = document.getElementById('curtainDurationValue');
            if (curtainDurationSlider && curtainDurationValue) {
                curtainDurationSlider.value = currentCurtainDuration;
                curtainDurationValue.textContent = currentCurtainDuration;

                // Add event listener for real-time value update
                curtainDurationSlider.addEventListener('input', function() {
                    curtainDurationValue.textContent = this.value;
                });
            }

            // Update earthquake toggle
            const earthquakeToggle = document.getElementById('earthquakeToggle');
            const earthquakeToggleLabel = document.getElementById('earthquakeToggleLabel');
            if (earthquakeToggle && earthquakeToggleLabel) {
                earthquakeToggle.checked = currentEarthquakeEnabled;
                earthquakeToggleLabel.textContent = currentEarthquakeEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                earthquakeToggle.addEventListener('change', function() {
                    earthquakeToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update randomize toggle
            const randomizeToggle = document.getElementById('randomizeToggle');
            if (randomizeToggle) {
                randomizeToggle.checked = currentRandomizeEnabled;
            }

            // Update boot sequence toggle
            const bootSequenceToggle = document.getElementById('bootSequenceToggle');
            const bootSequenceToggleLabel = document.getElementById('bootSequenceToggleLabel');
            if (bootSequenceToggle && bootSequenceToggleLabel) {
                bootSequenceToggle.checked = currentBootSequenceEnabled;
                bootSequenceToggleLabel.textContent = currentBootSequenceEnabled ? 'Enabled' : 'Disabled';

                // Add event listener for real-time label update
                bootSequenceToggle.addEventListener('change', function() {
                    bootSequenceToggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // Update builders media fields
            const buildersMediaType = document.getElementById('buildersMediaType');
            const buildersMediaUrl = document.getElementById('buildersMediaUrl');
            if (buildersMediaType && buildersMediaUrl) {
                buildersMediaType.value = currentBuildersMedia.type || 'image';
                buildersMediaUrl.value = currentBuildersMedia.url || '';
            }

            // Update boot script textarea
            const bootScriptTextarea = document.getElementById('bootScriptTextarea');
            if (bootScriptTextarea) {
                bootScriptTextarea.value = currentBootScript;
            }

            // Update background image URL
            const backgroundImageUrlInput = document.getElementById('backgroundImageUrl');
            if (backgroundImageUrlInput) {
                backgroundImageUrlInput.value = currentBackgroundImageUrl;
            }

            // Update cinematic state image URLs
            const intermissionImageUrlInput = document.getElementById('intermissionImageUrl');
            if (intermissionImageUrlInput) {
                intermissionImageUrlInput.value = currentIntermissionImageUrl;
            }
            const techDifficultyImageUrlInput = document.getElementById('techDifficultyImageUrl');
            if (techDifficultyImageUrlInput) {
                techDifficultyImageUrlInput.value = currentTechDifficultyImageUrl;
            }
            const finImageUrlInput = document.getElementById('finImageUrl');
            if (finImageUrlInput) {
                finImageUrlInput.value = currentFinImageUrl;
            }

            // Update meltdown configuration
            const meltdownMessageInput = document.getElementById('meltdownMessage');
            if (meltdownMessageInput) {
                meltdownMessageInput.value = currentMeltdownMessage;
            }
            const meltdownAudioURLInput = document.getElementById('meltdownAudioURL');
            if (meltdownAudioURLInput) {
                meltdownAudioURLInput.value = currentMeltdownAudioURL;
            }

            // Update MST3K overlay URL
            const mst3kOverlayURLInput = document.getElementById('mst3kOverlayURL');
            if (mst3kOverlayURLInput) {
                mst3kOverlayURLInput.value = currentMst3kOverlayURL;
            }

            // Update MST3K glow intensity
            const mst3kGlowIntensityInput = document.getElementById('mst3kGlowIntensity');
            if (mst3kGlowIntensityInput) {
                mst3kGlowIntensityInput.value = currentMst3kGlowIntensity;
            }

            // Update Theater Frame URL
            const theaterFrameURLInput = document.getElementById('theaterFrameURL');
            if (theaterFrameURLInput) {
                theaterFrameURLInput.value = currentTheaterFrameURL;
            }

            // Update Global Ambient Audio URL
            const globalAmbientAudioURLInput = document.getElementById('globalAmbientAudioURL');
            if (globalAmbientAudioURLInput) {
                globalAmbientAudioURLInput.value = currentGlobalAmbientAudioURL;
            }

            renderThoughtCards();
            renderSecretCommands();
            renderFinalActionsGrid();
        }

        // Render secret commands list
        function renderSecretCommands() {
            const list = document.getElementById('secretCommandsList');
            if (!list) return;

            list.innerHTML = '';

            currentSecretCommands.forEach((command, index) => {
                const card = document.createElement('div');
                card.className = 'secret-command-card';
                card.id = `secret-command-${index}`;

                const showUrlField = command.action === 'redirect';

                card.innerHTML = `
                    <div class="secret-command-header">
                        <div class="secret-command-keyword">
                            <span class="keyword-badge">${escapeHtml(command.keyword)}</span>
                        </div>
                        <div class="secret-command-controls">
                            <div class="active-toggle-container">
                                <input type="checkbox" id="cmd-enabled-${index}" class="active-checkbox" ${command.enabled ? 'checked' : ''} onchange="handleCommandEnabledChange(${index})">
                                <label for="cmd-enabled-${index}" class="active-label">Enabled</label>
                            </div>
                            <button type="button" class="delete-command-btn" onclick="deleteSecretCommand(${index})">Delete</button>
                        </div>
                    </div>
                    <div class="secret-command-body">
                        <div class="form-group">
                            <label>Keyword</label>
                            <input type="text" id="cmd-keyword-${index}" value="${escapeHtml(command.keyword)}" placeholder="e.g., FOREST" onchange="updateCommandKeyword(${index})" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Action Type</label>
                            <select id="cmd-action-${index}" onchange="handleCommandActionChange(${index})">
                                ${SECRET_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${command.action === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group url-field" id="cmd-url-group-${index}" style="${showUrlField ? '' : 'display: none;'}">
                            <label>Redirect URL</label>
                            <input type="text" id="cmd-url-${index}" value="${escapeHtml(command.url || '')}" placeholder="e.g., admin.html or https://..." onchange="updateCommandUrl(${index})">
                        </div>
                        <div class="form-group" style="grid-column: ${showUrlField ? '1' : '1 / -1'};">
                            <label>Description (optional)</label>
                            <input type="text" id="cmd-desc-${index}" value="${escapeHtml(command.description || '')}" placeholder="Describe what this command does" onchange="updateCommandDescription(${index})">
                        </div>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        // Handle command enabled checkbox change
        function handleCommandEnabledChange(index) {
            const checkbox = document.getElementById(`cmd-enabled-${index}`);
            if (checkbox) {
                currentSecretCommands[index].enabled = checkbox.checked;
            }
        }

        // Handle command action type change
        function handleCommandActionChange(index) {
            const select = document.getElementById(`cmd-action-${index}`);
            const urlGroup = document.getElementById(`cmd-url-group-${index}`);

            if (select) {
                currentSecretCommands[index].action = select.value;

                // Show/hide URL field based on action type
                if (urlGroup) {
                    urlGroup.style.display = select.value === 'redirect' ? '' : 'none';
                }

                // Update the keyword badge display
                const keywordInput = document.getElementById(`cmd-keyword-${index}`);
                if (keywordInput) {
                    const badge = document.querySelector(`#secret-command-${index} .keyword-badge`);
                    if (badge) {
                        badge.textContent = keywordInput.value.toUpperCase();
                    }
                }
            }
        }

        // Update command keyword
        function updateCommandKeyword(index) {
            const input = document.getElementById(`cmd-keyword-${index}`);
            if (input) {
                const keyword = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                input.value = keyword;
                currentSecretCommands[index].keyword = keyword;

                // Update the badge
                const badge = document.querySelector(`#secret-command-${index} .keyword-badge`);
                if (badge) {
                    badge.textContent = keyword;
                }
            }
        }

        // Update command URL
        function updateCommandUrl(index) {
            const input = document.getElementById(`cmd-url-${index}`);
            if (input) {
                currentSecretCommands[index].url = input.value;
            }
        }

        // Update command description
        function updateCommandDescription(index) {
            const input = document.getElementById(`cmd-desc-${index}`);
            if (input) {
                currentSecretCommands[index].description = input.value;
            }
        }

        // Add new secret command
        function addNewSecretCommand() {
            const newCommand = {
                keyword: 'NEWCMD',
                action: 'redirect',
                url: '',
                enabled: true,
                description: ''
            };

            currentSecretCommands.push(newCommand);
            renderSecretCommands();

            // Scroll to new command and focus keyword input
            setTimeout(() => {
                const newIndex = currentSecretCommands.length - 1;
                const newCard = document.getElementById(`secret-command-${newIndex}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const keywordInput = document.getElementById(`cmd-keyword-${newIndex}`);
                    if (keywordInput) {
                        keywordInput.focus();
                        keywordInput.select();
                    }
                }
            }, 100);
        }

        // Delete secret command
        function deleteSecretCommand(index) {
            if (confirm('Are you sure you want to delete this secret command?')) {
                currentSecretCommands.splice(index, 1);
                renderSecretCommands();
            }
        }

        // Add new thought
        function addNewThought() {
            const newIndex = currentThoughts.length;

            // Add empty thought with defaults
            currentThoughts.push('');
            currentResponses.push('');
            currentActions.push({ type: 'none', url: '', logo: '', linkText: 'Click here' });
            currentActiveStates.push(true);
            currentYesRedirectIndices.push('');
            currentNoRedirectIndices.push('');
            currentChoiceATexts.push('');
            currentChoiceBTexts.push('');
            currentChoiceAActions.push({ type: 'none', endAction: false });
            currentChoiceBActions.push({ type: 'none', endAction: false });
            currentTypingSpeeds.push(100);  // Default to 100ms (middle of 10-200 range)
            currentMoods.push('stable');     // Default to 'stable' mood
            currentSceneAudioOverrides.push({ url: '', loop: true });  // Default to no override

            renderThoughtCards();

            // Scroll to new thought and focus input
            setTimeout(() => {
                const newCard = document.getElementById(`thought-card-${newIndex}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const thoughtInput = document.getElementById(`thought-${newIndex}`);
                    if (thoughtInput) {
                        thoughtInput.focus();
                    }
                }
            }, 100);
        }

        // Delete thought
        function deleteThought(index) {
            if (currentThoughts.length <= 1) {
                alert('You must have at least one thought.');
                return;
            }

            if (confirm('Are you sure you want to delete this thought?')) {
                currentThoughts.splice(index, 1);
                currentResponses.splice(index, 1);
                currentActions.splice(index, 1);
                currentActiveStates.splice(index, 1);
                currentYesRedirectIndices.splice(index, 1);
                currentNoRedirectIndices.splice(index, 1);
                currentChoiceATexts.splice(index, 1);
                currentChoiceBTexts.splice(index, 1);
                currentChoiceAActions.splice(index, 1);
                currentChoiceBActions.splice(index, 1);
                currentTypingSpeeds.splice(index, 1);
                currentMoods.splice(index, 1);
                currentSceneAudioOverrides.splice(index, 1);
                renderThoughtCards();
            }
        }

        // Update mood preview
        function updateMoodPreview(mood) {
            const moodPreview = document.getElementById('moodPreview');
            if (!moodPreview) return;

            // Remove all mood classes
            moodPreview.classList.remove('stable', 'glitchy', 'urgent');

            // Add the selected mood class
            moodPreview.classList.add(mood);
        }

        // Render thought cards - Simplified CYOA layout with scene-specific atmosphere
        function renderThoughtCards() {
            const grid = document.getElementById('thoughtsGrid');
            grid.innerHTML = '';

            // Iterate over actual thoughts array length
            const thoughtCount = currentThoughts.length;
            for (let i = 0; i < thoughtCount; i++) {
                const isActive = currentActiveStates[i] !== false; // Default to true
                const choiceAAction = currentChoiceAActions[i] || { type: 'none', endAction: false };
                const choiceBAction = currentChoiceBActions[i] || { type: 'none', endAction: false };
                const typingSpeed = currentTypingSpeeds[i] !== undefined ? currentTypingSpeeds[i] : 100;
                const mood = currentMoods[i] || 'stable';
                const card = document.createElement('div');
                card.className = 'thought-card' + (isActive ? '' : ' inactive');
                card.id = `thought-card-${i}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-number">${i + 1}</span>
                        <div class="card-controls">
                            <div class="active-toggle-container">
                                <input type="checkbox" id="active-${i}" class="active-checkbox" ${isActive ? 'checked' : ''} onchange="handleActiveChange(${i})">
                                <label for="active-${i}" class="active-label">Active</label>
                            </div>
                            <button type="button" class="delete-command-btn" onclick="deleteThought(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Story Text</label>
                        <small style="display: block; color: rgba(31, 31, 31, 0.6); margin-bottom: 0.5rem; font-size: 0.8rem;">Use &lt;&lt;name&gt;&gt; to insert the user's name</small>
                        <textarea id="thought-${i}" class="thought-textarea" rows="10" placeholder="Enter story paragraph... Use {misspelled} for backspace effect and <<name>> for user name.">${escapeHtml(currentThoughts[i] || '')}</textarea>
                    </div>

                    <!-- Scene Atmosphere Controls -->
                    <div style="background: rgba(91, 95, 234, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--accent);">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: var(--accent);">Scene Atmosphere</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Typing Speed (10ms-200ms)</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="range" id="typing-speed-${i}" min="10" max="200" value="${typingSpeed}" class="speed-slider" style="flex: 1;" oninput="updateTypingSpeedDisplay(${i})">
                                    <span id="typing-speed-value-${i}" style="min-width: 50px; text-align: right; font-weight: 600; color: var(--accent);">${typingSpeed}ms</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                                    <span>Instant</span>
                                    <span>Slow</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>AI System Mood</label>
                                <select id="mood-${i}" class="mood-select">
                                    <option value="stable" ${mood === 'stable' ? 'selected' : ''}>Stable - Steady rhythm</option>
                                    <option value="glitchy" ${mood === 'glitchy' ? 'selected' : ''}>Glitchy - Irregular typing</option>
                                    <option value="urgent" ${mood === 'urgent' ? 'selected' : ''}>Urgent - Red, fast typing</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(91, 95, 234, 0.2);">
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <label>Override Ambient Audio URL</label>
                                <div class="url-input-wrapper">
                                    <input type="url" id="scene-audio-${i}" value="${escapeHtml(currentSceneAudioOverrides[i]?.url || '')}" placeholder="https://example.com/scene-audio.mp3">
                                    <button type="button" class="browse-assets-btn" onclick="openAssetPicker('scene-audio-${i}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                        </svg>
                                        Browse
                                    </button>
                                </div>
                            </div>
                            <div class="active-toggle-container" style="margin-top: 0.5rem;">
                                <input type="checkbox" id="scene-audio-loop-${i}" class="active-checkbox" ${currentSceneAudioOverrides[i]?.loop !== false ? 'checked' : ''}>
                                <label for="scene-audio-loop-${i}" class="active-label">Loop Audio</label>
                            </div>
                            <p style="font-size: 0.7rem; color: rgba(31, 31, 31, 0.5); margin-top: 0.25rem;">
                                When set, this audio will cross-fade in when entering this scene. Leave empty to use global ambient.
                            </p>
                        </div>
                    </div>

                    <!-- Choice A Section -->
                    <div style="background: rgba(52, 255, 53, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #34ff35;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: #34ff35;">Choice A</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Button Label (blank = "Yes")</label>
                            <input type="text" id="choice-a-text-${i}" value="${escapeHtml(currentChoiceATexts[i] || '')}" placeholder="e.g., Get in the vehicle">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Jump to Index (blank = next)</label>
                            <input type="number" id="yes-redirect-${i}" value="${escapeHtml(currentYesRedirectIndices[i] || '')}" placeholder="e.g., 3" min="1" max="${thoughtCount}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Action Type</label>
                            <select id="choice-a-action-type-${i}" onchange="handleChoiceActionChange('A', ${i})">
                                ${CHOICE_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${choiceAAction.type === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="active-toggle-container" id="choice-a-end-action-${i}" style="${choiceAAction.type === 'none' ? 'display: none;' : ''}">
                            <input type="checkbox" id="choice-a-end-${i}" class="active-checkbox" ${choiceAAction.endAction ? 'checked' : ''}>
                            <label for="choice-a-end-${i}" class="active-label" style="color: #ef4444;">End Action (stops story)</label>
                        </div>
                    </div>

                    <!-- Choice B Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 3px solid rgba(255, 255, 255, 0.3);">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; font-weight: 600; color: rgba(31, 31, 31, 0.8);">Choice B</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Button Label (blank = "No")</label>
                            <input type="text" id="choice-b-text-${i}" value="${escapeHtml(currentChoiceBTexts[i] || '')}" placeholder="e.g., Keep running toward the lights">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Jump to Index (blank = next)</label>
                            <input type="number" id="no-redirect-${i}" value="${escapeHtml(currentNoRedirectIndices[i] || '')}" placeholder="e.g., 5" min="1" max="${thoughtCount}">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Action Type</label>
                            <select id="choice-b-action-type-${i}" onchange="handleChoiceActionChange('B', ${i})">
                                ${CHOICE_ACTION_TYPES.map(type => `
                                    <option value="${type.value}" ${choiceBAction.type === type.value ? 'selected' : ''}>
                                        ${type.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="active-toggle-container" id="choice-b-end-action-${i}" style="${choiceBAction.type === 'none' ? 'display: none;' : ''}">
                            <input type="checkbox" id="choice-b-end-${i}" class="active-checkbox" ${choiceBAction.endAction ? 'checked' : ''}>
                            <label for="choice-b-end-${i}" class="active-label" style="color: #ef4444;">End Action (stops story)</label>
                        </div>
                    </div>

                    <!-- Hidden fields for backward compatibility -->
                    <input type="hidden" id="response-${i}" value="${escapeHtml(currentResponses[i] || '')}">
                `;
                grid.appendChild(card);
            }
        }

        // Render Final Actions Grid
        function renderFinalActionsGrid() {
            const grid = document.getElementById('finalActionsGrid');
            if (!grid) return;

            grid.innerHTML = '';

            FINAL_ACTION_CONFIG.forEach(action => {
                const card = document.createElement('div');
                card.className = 'final-action-card';
                const soundUrl = currentFinalActionSounds[action.type] || '';

                card.innerHTML = `
                    <div class="card-header">
                        <span class="action-icon">${action.icon}</span>
                        <span class="action-name">${action.label}</span>
                    </div>
                    <div class="form-group">
                        <label>Ending Sound URL (WAV/MP3)</label>
                        <div class="url-input-wrapper">
                            <input type="url"
                                   id="final-action-sound-${action.type}"
                                   value="${escapeHtml(soundUrl)}"
                                   placeholder="https://example.com/ending-sound.mp3"
                                   onchange="updateFinalActionSound('${action.type}')">
                            <button type="button" class="browse-assets-btn" onclick="openAssetPicker('final-action-sound-${action.type}')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                </svg>
                                Browse
                            </button>
                        </div>
                        <p class="audio-hint">Audio plays immediately when the Death Bridge button is clicked for this action type.</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Update final action sound URL
        function updateFinalActionSound(actionType) {
            const input = document.getElementById(`final-action-sound-${actionType}`);
            if (input) {
                currentFinalActionSounds[actionType] = input.value;
                saveAllChanges();
            }
        }

        // Expose to global scope
        window.updateFinalActionSound = updateFinalActionSound;

        // Handle choice action type change (show/hide end action toggle)
        function handleChoiceActionChange(choice, index) {
            const select = document.getElementById(`choice-${choice.toLowerCase()}-action-type-${index}`);
            const endActionContainer = document.getElementById(`choice-${choice.toLowerCase()}-end-action-${index}`);

            if (select && endActionContainer) {
                const actionType = select.value;
                endActionContainer.style.display = actionType === 'none' ? 'none' : '';

                // Update the current data
                if (choice === 'A') {
                    if (!currentChoiceAActions[index]) {
                        currentChoiceAActions[index] = { type: 'none', endAction: false };
                    }
                    currentChoiceAActions[index].type = actionType;
                } else {
                    if (!currentChoiceBActions[index]) {
                        currentChoiceBActions[index] = { type: 'none', endAction: false };
                    }
                    currentChoiceBActions[index].type = actionType;
                }
            }
        }

        // Handle active checkbox change
        function handleActiveChange(index) {
            const checkbox = document.getElementById(`active-${index}`);
            const card = document.getElementById(`thought-card-${index}`);

            if (checkbox && card) {
                const isActive = checkbox.checked;
                currentActiveStates[index] = isActive;

                if (isActive) {
                    card.classList.remove('inactive');
                } else {
                    card.classList.add('inactive');
                }
            }
        }

        // Update typing speed display value in real-time
        function updateTypingSpeedDisplay(index) {
            const slider = document.getElementById(`typing-speed-${index}`);
            const display = document.getElementById(`typing-speed-value-${index}`);
            if (slider && display) {
                display.textContent = slider.value + 'ms';
            }
        }

        // Render action-specific fields
        function renderActionFields(index, action) {
            const linkTextField = `
                <div class="form-group">
                    <label>Link Text (shown in terminal)</label>
                    <input type="text" id="action-linktext-${index}" value="${escapeHtml(action.linkText || 'Click here')}" placeholder="Click here">
                </div>
            `;

            switch (action.type) {
                case 'video':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>YouTube URL</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                    `;
                case 'image':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://example.com/image.jpg">
                        </div>
                    `;
                case 'logo':
                    return `
                        ${linkTextField}
                        <div class="form-group">
                            <label>ASCII Logo</label>
                            <textarea id="action-logo-${index}" placeholder="Enter ASCII art...">${escapeHtml(action.logo || '')}</textarea>
                        </div>
                    `;
                case 'audio':
                    return `
                        <div class="form-group">
                            <label>Audio Trigger Text (clickable link)</label>
                            <input type="text" id="action-linktext-${index}" value="${escapeHtml(action.linkText || 'Play Audio')}" placeholder="Play Audio">
                        </div>
                        <div class="form-group">
                            <label>Audio File URL (.wav, .mp3, etc.)</label>
                            <input type="url" id="action-url-${index}" value="${escapeHtml(action.url || '')}" placeholder="https://example.com/audio.wav">
                        </div>
                    `;
                case 'matrix':
                    return linkTextField;
                case 'contact':
                    return linkTextField;
                case 'system-meltdown':
                    return linkTextField;
                default:
                    return '';
            }
        }

        // Handle action type change
        function handleActionTypeChange(index) {
            const select = document.getElementById(`action-type-${index}`);
            const fieldsContainer = document.getElementById(`action-fields-${index}`);
            const actionType = select.value;

            // Update current action
            if (!currentActions[index]) {
                currentActions[index] = { type: 'none', url: '', logo: '', linkText: 'Click here' };
            }
            currentActions[index].type = actionType;

            // Show/hide fields container
            if (actionType === 'none') {
                fieldsContainer.classList.add('hidden');
                fieldsContainer.innerHTML = '';
            } else {
                fieldsContainer.classList.remove('hidden');
                fieldsContainer.innerHTML = renderActionFields(index, currentActions[index]);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Collect current form data into memory (no localStorage persistence)
        function collectCurrentFormData() {
            // Collect hero text
            const heroInput = document.getElementById('heroText');
            if (heroInput) {
                currentHeroText = heroInput.value || defaultHeroText;
            }

            // Collect studio production name
            const studioNameInput = document.getElementById('studioProductionName');
            if (studioNameInput) {
                currentStudioProductionName = studioNameInput.value || 'The Ghost';
            }

            // Collect ghost memory setting
            const ghostMemoryToggle = document.getElementById('ghostMemoryToggle');
            if (ghostMemoryToggle) {
                currentGhostMemoryEnabled = ghostMemoryToggle.checked;
            }

            // Collect choice buttons setting
            const choiceButtonsToggle = document.getElementById('choiceButtonsToggle');
            if (choiceButtonsToggle) {
                currentChoiceButtonsEnabled = choiceButtonsToggle.checked;
            }

            // Collect matrix fade duration
            const matrixFadeSlider = document.getElementById('matrixFadeSlider');
            if (matrixFadeSlider) {
                currentMatrixFadeDuration = parseFloat(matrixFadeSlider.value) || 1.5;
            }

            // Collect earthquake duration
            const earthquakeDurationSlider = document.getElementById('earthquakeDurationSlider');
            if (earthquakeDurationSlider) {
                currentEarthquakeDuration = parseFloat(earthquakeDurationSlider.value) || 1.5;
            }

            // Collect curtain duration
            const curtainDurationSlider = document.getElementById('curtainDurationSlider');
            if (curtainDurationSlider) {
                currentCurtainDuration = parseFloat(curtainDurationSlider.value) || 4;
            }

            // Collect earthquake transition setting
            const earthquakeToggle = document.getElementById('earthquakeToggle');
            if (earthquakeToggle) {
                currentEarthquakeEnabled = earthquakeToggle.checked;
            }

            // Collect randomize setting
            const randomizeToggle = document.getElementById('randomizeToggle');
            if (randomizeToggle) {
                currentRandomizeEnabled = randomizeToggle.checked;
            }

            // Collect boot sequence setting
            const bootSequenceToggle = document.getElementById('bootSequenceToggle');
            if (bootSequenceToggle) {
                currentBootSequenceEnabled = bootSequenceToggle.checked;
            }

            // Collect builders media settings
            const buildersMediaType = document.getElementById('buildersMediaType');
            const buildersMediaUrl = document.getElementById('buildersMediaUrl');
            if (buildersMediaType && buildersMediaUrl) {
                currentBuildersMedia = {
                    type: buildersMediaType.value,
                    url: buildersMediaUrl.value
                };
            }

            // Collect boot script
            const bootScriptTextarea = document.getElementById('bootScriptTextarea');
            if (bootScriptTextarea) {
                currentBootScript = bootScriptTextarea.value;
            }

            // Collect background image URL
            const backgroundImageUrlInput = document.getElementById('backgroundImageUrl');
            if (backgroundImageUrlInput) {
                currentBackgroundImageUrl = backgroundImageUrlInput.value;
            }

            // Collect cinematic state image URLs
            const intermissionImageUrlInput = document.getElementById('intermissionImageUrl');
            if (intermissionImageUrlInput) {
                currentIntermissionImageUrl = intermissionImageUrlInput.value;
            }
            const techDifficultyImageUrlInput = document.getElementById('techDifficultyImageUrl');
            if (techDifficultyImageUrlInput) {
                currentTechDifficultyImageUrl = techDifficultyImageUrlInput.value;
            }
            const finImageUrlInput = document.getElementById('finImageUrl');
            if (finImageUrlInput) {
                currentFinImageUrl = finImageUrlInput.value;
            }

            // Collect meltdown configuration
            const meltdownMessageInput = document.getElementById('meltdownMessage');
            if (meltdownMessageInput) {
                currentMeltdownMessage = meltdownMessageInput.value;
            }
            const meltdownAudioURLInput = document.getElementById('meltdownAudioURL');
            if (meltdownAudioURLInput) {
                currentMeltdownAudioURL = meltdownAudioURLInput.value;
            }

            // Collect MST3K overlay URL
            const mst3kOverlayURLInput = document.getElementById('mst3kOverlayURL');
            if (mst3kOverlayURLInput) {
                currentMst3kOverlayURL = mst3kOverlayURLInput.value;
            }

            // Collect MST3K glow intensity
            const mst3kGlowIntensityInput = document.getElementById('mst3kGlowIntensity');
            if (mst3kGlowIntensityInput) {
                currentMst3kGlowIntensity = parseFloat(mst3kGlowIntensityInput.value) || 0.6;
            }

            // Collect Theater Frame URL
            const theaterFrameURLInput = document.getElementById('theaterFrameURL');
            if (theaterFrameURLInput) {
                currentTheaterFrameURL = theaterFrameURLInput.value;
            }

            // Collect Global Ambient Audio URL
            const globalAmbientAudioURLInput = document.getElementById('globalAmbientAudioURL');
            if (globalAmbientAudioURLInput) {
                currentGlobalAmbientAudioURL = globalAmbientAudioURLInput.value;
            }

            // Collect secret commands
            for (let i = 0; i < currentSecretCommands.length; i++) {
                const keywordInput = document.getElementById(`cmd-keyword-${i}`);
                const actionSelect = document.getElementById(`cmd-action-${i}`);
                const urlInput = document.getElementById(`cmd-url-${i}`);
                const descInput = document.getElementById(`cmd-desc-${i}`);
                const enabledCheckbox = document.getElementById(`cmd-enabled-${i}`);

                if (keywordInput) {
                    currentSecretCommands[i].keyword = keywordInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                }
                if (actionSelect) {
                    currentSecretCommands[i].action = actionSelect.value;
                }
                if (urlInput) {
                    currentSecretCommands[i].url = urlInput.value;
                }
                if (descInput) {
                    currentSecretCommands[i].description = descInput.value;
                }
                if (enabledCheckbox) {
                    currentSecretCommands[i].enabled = enabledCheckbox.checked;
                }
            }

            // Collect thoughts, responses, actions, and active states (dynamic count)
            const thoughtCount = currentThoughts.length;
            for (let i = 0; i < thoughtCount; i++) {
                const thoughtInput = document.getElementById(`thought-${i}`);
                const responseInput = document.getElementById(`response-${i}`);

                if (thoughtInput) {
                    currentThoughts[i] = thoughtInput.value;
                }
                if (responseInput) {
                    currentResponses[i] = responseInput.value;
                }

                // Collect active state
                const activeCheckbox = document.getElementById(`active-${i}`);
                if (activeCheckbox) {
                    currentActiveStates[i] = activeCheckbox.checked;
                }

                // Collect redirect indices
                const yesRedirectInput = document.getElementById(`yes-redirect-${i}`);
                const noRedirectInput = document.getElementById(`no-redirect-${i}`);
                if (yesRedirectInput) {
                    currentYesRedirectIndices[i] = yesRedirectInput.value;
                }
                if (noRedirectInput) {
                    currentNoRedirectIndices[i] = noRedirectInput.value;
                }

                // Collect choice button texts
                const choiceATextInput = document.getElementById(`choice-a-text-${i}`);
                const choiceBTextInput = document.getElementById(`choice-b-text-${i}`);
                if (choiceATextInput) {
                    currentChoiceATexts[i] = choiceATextInput.value;
                }
                if (choiceBTextInput) {
                    currentChoiceBTexts[i] = choiceBTextInput.value;
                }

                // Collect choice A action configuration
                const choiceAActionSelect = document.getElementById(`choice-a-action-type-${i}`);
                const choiceAEndCheckbox = document.getElementById(`choice-a-end-${i}`);
                if (!currentChoiceAActions[i]) {
                    currentChoiceAActions[i] = { type: 'none', endAction: false };
                }
                if (choiceAActionSelect) {
                    currentChoiceAActions[i].type = choiceAActionSelect.value;
                }
                if (choiceAEndCheckbox) {
                    currentChoiceAActions[i].endAction = choiceAEndCheckbox.checked;
                }

                // Collect choice B action configuration
                const choiceBActionSelect = document.getElementById(`choice-b-action-type-${i}`);
                const choiceBEndCheckbox = document.getElementById(`choice-b-end-${i}`);
                if (!currentChoiceBActions[i]) {
                    currentChoiceBActions[i] = { type: 'none', endAction: false };
                }
                if (choiceBActionSelect) {
                    currentChoiceBActions[i].type = choiceBActionSelect.value;
                }
                if (choiceBEndCheckbox) {
                    currentChoiceBActions[i].endAction = choiceBEndCheckbox.checked;
                }

                // Collect per-card typing speed (10-200ms range)
                const typingSpeedSlider = document.getElementById(`typing-speed-${i}`);
                if (typingSpeedSlider) {
                    currentTypingSpeeds[i] = parseInt(typingSpeedSlider.value, 10) || 100;
                }

                // Collect per-card AI mood
                const moodSelect = document.getElementById(`mood-${i}`);
                if (moodSelect) {
                    currentMoods[i] = moodSelect.value || 'stable';
                }

                // Collect per-card scene audio override
                const sceneAudioInput = document.getElementById(`scene-audio-${i}`);
                const sceneAudioLoopCheckbox = document.getElementById(`scene-audio-loop-${i}`);
                if (!currentSceneAudioOverrides[i]) {
                    currentSceneAudioOverrides[i] = { url: '', loop: true };
                }
                if (sceneAudioInput) {
                    currentSceneAudioOverrides[i].url = sceneAudioInput.value;
                }
                if (sceneAudioLoopCheckbox) {
                    currentSceneAudioOverrides[i].loop = sceneAudioLoopCheckbox.checked;
                }

                // Legacy: Keep old action type for backwards compatibility (default to none)
                if (!currentActions[i]) {
                    currentActions[i] = { type: 'none', url: '', logo: '', linkText: 'Click here' };
                }
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = 'toast visible ' + type;

            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // Push configuration to Firebase (replaced downloadConfig)
        function downloadConfig() {
            // Collect current form data
            collectCurrentFormData();

            const config = {
                heroText: currentHeroText,
                thoughts: [...currentThoughts],
                responses: [...currentResponses],
                actions: currentActions.map(a => ({...a})),
                activeStates: [...currentActiveStates],
                yesRedirectIndices: [...currentYesRedirectIndices],
                noRedirectIndices: [...currentNoRedirectIndices],
                choiceATexts: [...currentChoiceATexts],
                choiceBTexts: [...currentChoiceBTexts],
                choiceAActions: currentChoiceAActions.map(a => ({...a})),
                choiceBActions: currentChoiceBActions.map(a => ({...a})),
                typingSpeeds: [...currentTypingSpeeds],
                moods: [...currentMoods],
                settings: {
                    ghostMemoryEnabled: currentGhostMemoryEnabled,
                    choiceButtonsEnabled: currentChoiceButtonsEnabled,
                    matrixFadeDuration: currentMatrixFadeDuration,
                    earthquakeDuration: currentEarthquakeDuration,
                    curtainDuration: currentCurtainDuration,
                    earthquakeEnabled: currentEarthquakeEnabled,
                    bootSequenceEnabled: currentBootSequenceEnabled,
                    randomizeEnabled: currentRandomizeEnabled
                },
                secretCommands: currentSecretCommands.map(cmd => ({...cmd})),
                buildersMedia: {...currentBuildersMedia},
                bootScript: currentBootScript,
                backgroundImageUrl: currentBackgroundImageUrl,
                intermissionImageUrl: currentIntermissionImageUrl,
                techDifficultyImageUrl: currentTechDifficultyImageUrl,
                finImageUrl: currentFinImageUrl,
                meltdownMessage: currentMeltdownMessage,
                meltdownAudioURL: currentMeltdownAudioURL,
                mst3kOverlayURL: currentMst3kOverlayURL,
                mst3kGlowIntensity: currentMst3kGlowIntensity,
                theaterFrameURL: currentTheaterFrameURL,
                globalAmbientAudioURL: currentGlobalAmbientAudioURL,
                autoplayAfterIntro: currentAutoplayAfterIntro,
                sceneAudioOverrides: currentSceneAudioOverrides.map(s => ({...s})),
                studioProductionName: currentStudioProductionName,
                finalActionSounds: {...currentFinalActionSounds}
            };

            // Push to Firebase instead of downloading
            set(ref(db, 'siteConfig'), config)
                .then(() => {
                    showToast("Live Update Successful! All sites updated.", "success");
                })
                .catch((error) => {
                    console.error("Firebase Update Failed:", error);
                    showToast("Update failed. Check console.", "error");
                });
        }

        // Reset to defaults - DISABLED (Firebase is sole source of truth)
        function factoryReset() {
            showToast('Reset to Defaults is disabled. Firebase is the sole source of truth.', 'error');
            return;
        }

        // Tab switching function
        function switchAdminTab(tabName) {
            // Update tab buttons
            const tabButtons = document.querySelectorAll('.admin-tab-btn');
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update tab panels
            const configPanel = document.getElementById('configTabPanel');
            const storyPanel = document.getElementById('storyTabPanel');
            const finalActionsPanel = document.getElementById('finalActionsTabPanel');

            // Hide all panels first
            configPanel.classList.remove('active');
            storyPanel.classList.remove('active');
            finalActionsPanel.classList.remove('active');

            // Show selected panel
            if (tabName === 'config') {
                configPanel.classList.add('active');
            } else if (tabName === 'story') {
                storyPanel.classList.add('active');
            } else if (tabName === 'finalActions') {
                finalActionsPanel.classList.add('active');
            }
        }

        // Expose functions to global scope for onclick handlers
        window.handleCommandEnabledChange = handleCommandEnabledChange;
        window.handleCommandActionChange = handleCommandActionChange;
        window.updateCommandKeyword = updateCommandKeyword;
        window.updateCommandUrl = updateCommandUrl;
        window.updateCommandDescription = updateCommandDescription;
        window.addNewSecretCommand = addNewSecretCommand;
        window.deleteSecretCommand = deleteSecretCommand;
        window.addNewThought = addNewThought;
        window.deleteThought = deleteThought;
        window.handleActiveChange = handleActiveChange;
        window.handleActionTypeChange = handleActionTypeChange;
        window.handleChoiceActionChange = handleChoiceActionChange;
        window.updateTypingSpeedDisplay = updateTypingSpeedDisplay;
        window.downloadConfig = downloadConfig;
        window.factoryReset = factoryReset;
        window.switchAdminTab = switchAdminTab;

        // ========================================
        // GitHub Asset Picker
        // ========================================

        // Session cache for GitHub assets
        let assetCache = null;
        let currentTargetInput = null;
        let currentFilter = 'all';

        // GitHub repository configuration
        const GITHUB_REPO = 'jeffreypc1/imaginecraft-site';
        const GITHUB_BRANCH = 'main';
        const ASSETS_PATH = 'assets';

        // File type categories
        const FILE_CATEGORIES = {
            audio: ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'],
            image: ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'],
            video: ['mp4', 'webm', 'mov', 'avi', 'mkv']
        };

        // Get file category based on extension
        function getFileCategory(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            for (const [category, extensions] of Object.entries(FILE_CATEGORIES)) {
                if (extensions.includes(ext)) return category;
            }
            return 'other';
        }

        // Get icon for file type
        function getFileIcon(category) {
            switch (category) {
                case 'audio': return 'ðŸŽµ';
                case 'image': return 'ðŸ–¼ï¸';
                case 'video': return 'ðŸŽ¬';
                default: return 'ðŸ“„';
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Generate raw GitHub URL for a file
        function generateRawUrl(filename) {
            return `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${ASSETS_PATH}/${filename}`;
        }

        // Fetch assets from GitHub API
        async function fetchGitHubAssets() {
            // Return cached assets if available
            if (assetCache) {
                return assetCache;
            }

            const apiUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${ASSETS_PATH}?ref=${GITHUB_BRANCH}`;

            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const data = await response.json();

                // Filter to only include files (not directories)
                const files = data.filter(item => item.type === 'file').map(item => ({
                    name: item.name,
                    size: item.size,
                    category: getFileCategory(item.name),
                    rawUrl: generateRawUrl(item.name)
                }));

                // Sort by name
                files.sort((a, b) => a.name.localeCompare(b.name));

                // Cache the results
                assetCache = files;
                return files;
            } catch (error) {
                console.error('Failed to fetch GitHub assets:', error);
                throw error;
            }
        }

        // Render asset list
        function renderAssetList(assets) {
            const content = document.getElementById('assetPickerContent');
            const searchTerm = document.getElementById('assetSearchInput').value.toLowerCase();

            // Filter assets
            let filtered = assets;

            // Apply category filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(asset => asset.category === currentFilter);
            }

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(asset =>
                    asset.name.toLowerCase().includes(searchTerm)
                );
            }

            if (filtered.length === 0) {
                content.innerHTML = '<div class="asset-picker-empty">No matching files found</div>';
                return;
            }

            const listHtml = `
                <ul class="asset-list">
                    ${filtered.map(asset => `
                        <li class="asset-item" onclick="selectAsset('${escapeHtml(asset.rawUrl)}')">
                            <div class="asset-icon ${asset.category}">${getFileIcon(asset.category)}</div>
                            <div class="asset-details">
                                <div class="asset-name">${escapeHtml(asset.name)}</div>
                                <div class="asset-size">${formatFileSize(asset.size)}</div>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
            content.innerHTML = listHtml;
        }

        // Open asset picker modal
        async function openAssetPicker(inputId) {
            currentTargetInput = document.getElementById(inputId);
            if (!currentTargetInput) {
                console.error('Target input not found:', inputId);
                return;
            }

            const overlay = document.getElementById('assetPickerOverlay');
            const content = document.getElementById('assetPickerContent');
            const searchInput = document.getElementById('assetSearchInput');

            // Reset search and filter
            searchInput.value = '';
            currentFilter = 'all';
            updateFilterButtons();

            // Show modal
            overlay.classList.add('visible');

            // Show loading state
            content.innerHTML = '<div class="asset-picker-loading">Loading assets...</div>';

            try {
                const assets = await fetchGitHubAssets();
                renderAssetList(assets);
            } catch (error) {
                content.innerHTML = `<div class="asset-picker-error">Failed to load assets: ${error.message}</div>`;
            }
        }

        // Close asset picker modal
        function closeAssetPicker() {
            const overlay = document.getElementById('assetPickerOverlay');
            overlay.classList.remove('visible');
            currentTargetInput = null;
        }

        // Select an asset and insert URL into target input
        function selectAsset(url) {
            if (currentTargetInput) {
                currentTargetInput.value = url;
                // Trigger change event for any listeners
                currentTargetInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            closeAssetPicker();
            showToast('Asset URL inserted successfully!', 'success');
        }

        // Filter asset list by search term
        function filterAssetList() {
            if (assetCache) {
                renderAssetList(assetCache);
            }
        }

        // Handle filter button click
        function handleFilterClick(filter) {
            currentFilter = filter;
            updateFilterButtons();
            if (assetCache) {
                renderAssetList(assetCache);
            }
        }

        // Update filter button states
        function updateFilterButtons() {
            const buttons = document.querySelectorAll('#assetTypeFilter .filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.filter === currentFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Initialize filter button click handlers
        document.addEventListener('DOMContentLoaded', () => {
            const filterButtons = document.querySelectorAll('#assetTypeFilter .filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => handleFilterClick(btn.dataset.filter));
            });

            // Close modal on overlay click
            const overlay = document.getElementById('assetPickerOverlay');
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeAssetPicker();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('visible')) {
                    closeAssetPicker();
                }
            });
        });

        // Expose asset picker functions to global scope
        window.openAssetPicker = openAssetPicker;
        window.closeAssetPicker = closeAssetPicker;
        window.selectAsset = selectAsset;
        window.filterAssetList = filterAssetList;

        // Helper function to create browse button HTML
        function createBrowseButtonHtml(inputId) {
            return `<button type="button" class="browse-assets-btn" onclick="openAssetPicker('${inputId}')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
                Browse
            </button>`;
        }

        // Expose helper function
        window.createBrowseButtonHtml = createBrowseButtonHtml;

        // ========================================
        // Narrative Persistence Testing Tools
        // ========================================

        // Get user endings from localStorage
        function getUserEndingsAdmin() {
            try {
                const endings = localStorage.getItem('userEndings');
                return endings ? JSON.parse(endings) : [];
            } catch (e) {
                return [];
            }
        }

        // Update the ending count display
        function updateEndingCountDisplay() {
            const count = getUserEndingsAdmin().length;
            const countElement = document.getElementById('endingCountNumber');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // Get story part count from localStorage
        function getStoryPartCountAdmin() {
            try {
                const count = localStorage.getItem('storyPartCount');
                return count ? parseInt(count, 10) : 1;
            } catch (e) {
                return 1;
            }
        }

        // Update the story part display
        function updateStoryPartDisplay() {
            const count = getStoryPartCountAdmin();
            const countElement = document.getElementById('storyPartNumber');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // Reset narrative memory (clear all endings and story part counter)
        function resetNarrativeMemory() {
            if (confirm('This will clear all saved endings and reset the story part counter. The Ghost will no longer remember this user. Continue?')) {
                localStorage.removeItem('userEndings');
                localStorage.setItem('storyPartCount', '1');
                sessionStorage.removeItem('imaginecraft_ghost_awareness');
                updateEndingCountDisplay();
                updateStoryPartDisplay();
                alert('Narrative memory has been reset. Story Part reset to 1. The Ghost has forgotten.');
            }
        }

        // Simulate 3 deaths to trigger Ghost Awareness
        function simulateEndings() {
            const sampleEndings = ['trigger-fin', 'system-meltdown', 'supernova-flash'];
            localStorage.setItem('userEndings', JSON.stringify(sampleEndings));
            updateEndingCountDisplay();
            alert('Simulated 3 deaths: The Final Curtain, System Collapse, and Stellar Annihilation. Ghost Awareness will trigger on next visit to index.html');
        }

        // Export to window for onclick handlers
        window.resetNarrativeMemory = resetNarrativeMemory;
        window.simulateEndings = simulateEndings;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for remote config to load before initializing
            await configPromise;
            loadFromConfig();
            renderDashboard();

            // Initialize narrative persistence displays
            updateEndingCountDisplay();
            updateStoryPartDisplay();
        });
    </script>
</body>
</html>
